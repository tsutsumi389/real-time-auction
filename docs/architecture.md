# システムアーキテクチャ

## 概要

競走馬セリをモデルとしたリアルタイムオークションシステムのアーキテクチャ設計書です。
5分間の制限時間と入札時の5分延長機能を持ち、WebSocketによるリアルタイム通信を実現します。

**開発フェーズ**
- **第一フェーズ**: Webアプリケーション (Vue.js) の開発
- **第二フェーズ**: ネイティブモバイルアプリ (Swift/iOS) の開発

## システム全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント層                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────────────────────────────────────────────┐    │
│  │   Web Client (Phase 1)                                 │    │
│  │   (Vue.js 3 + Vite)                                    │    │
│  │                                                        │    │
│  │  - オークション閲覧 (全ユーザー)                          │    │
│  │  - 管理機能 (管理者・主催者)                             │    │
│  │  - 入札機能 (入札者)                                     │    │
│  │  - レスポンシブデザイン (PC/タブレット/スマホ対応)         │    │
│  └────────────────────────────────────────────────────────┘    │
│         │                                                       │
│         │ HTTPS/WSS                                            │
│         │                                                       │
│  ┌─────┴──────────────────────────────────────────────────┐    │
│  │   iOS App (Phase 2 - 予定)                             │    │
│  │   (Swift + SwiftUI)                                    │    │
│  │                                                        │    │
│  │  - 入札専用アプリ                                        │    │
│  │  - プッシュ通知 (APNs)                                   │    │
│  │  - リアルタイム更新                                      │    │
│  │  - オフライン対応                                        │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ HTTPS/WSS
                          │
┌─────────────────────┴───────────────────────────────────────────┐
│                      API Gateway層                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Nginx / AWS ALB / Cloud Load Balancer       │  │
│  │                                                          │  │
│  │  - SSL終端                                                │  │
│  │  - ルーティング (REST API / WebSocket)                    │  │
│  │  - レート制限                                              │  │
│  │  - 負荷分散                                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────┬───────────────────────────────────┬───────────────────┘
          │                                   │
          │ HTTP/REST                         │ WebSocket
          │                                   │
┌─────────┴─────────────────┐    ┌────────────┴─────────────────┐
│    アプリケーション層        │    │  リアルタイム通信層           │
├───────────────────────────┤    ├──────────────────────────────┤
│                           │    │                              │
│  ┌─────────────────────┐  │    │  ┌────────────────────────┐ │
│  │   REST API Server   │  │    │  │  WebSocket Server      │ │
│  │   (Node.js/Express) │  │    │  │  (Node.js/Socket.io)   │ │
│  │                     │  │    │  │                        │ │
│  │  エンドポイント:      │  │    │  │  イベント:              │ │
│  │  - 認証/認可         │  │    │  │  - auction:join        │ │
│  │  - ユーザー管理       │  │    │  │  - auction:bid         │ │
│  │  - オークションCRUD   │  │    │  │  - auction:update      │ │
│  │  - 商品(馬)管理      │  │    │  │  - auction:timer       │ │
│  │  - 入札履歴取得      │  │    │  │  - auction:extended    │ │
│  │  - レポート生成      │  │    │  │  - auction:ended       │ │
│  └─────────────────────┘  │    │  └────────────────────────┘ │
│            │              │    │             │                │
│            │              │    │             │                │
│  ┌─────────┴────────────┐ │    │  ┌──────────┴──────────────┐ │
│  │  Business Logic      │ │    │  │   Connection Manager    │ │
│  │                      │ │    │  │                         │ │
│  │  - 入札検証ロジック    │ │    │  │  - WebSocket接続管理    │ │
│  │  - タイマー延長ロジック │ │    │  │  - ルーム管理           │ │
│  │  - 落札判定          │ │    │  │  - ブロードキャスト      │ │
│  │  - 通知トリガー       │ │    │  │  - 再接続ハンドリング    │ │
│  └──────────────────────┘ │    │  └─────────────────────────┘ │
│                           │    │                              │
└───────────┬───────────────┘    └────────────┬─────────────────┘
            │                                 │
            │                                 │
            └────────────┬────────────────────┘
                         │
┌────────────────────────┴─────────────────────────────────────┐
│                        データ層                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────┐      ┌──────────────────────┐    │
│  │  Primary Database    │      │   Cache / Session    │    │
│  │  (PostgreSQL)        │      │   (Redis)            │    │
│  │                      │      │                      │    │
│  │  テーブル:            │      │  用途:                │    │
│  │  - users             │      │  - セッション管理      │    │
│  │  - auctions          │      │  - リアルタイム状態    │    │
│  │  - items (horses)    │      │  - 入札キュー         │    │
│  │  - bids              │      │  - タイマー状態       │    │
│  │  - notifications     │      │  - アクティブ接続情報  │    │
│  │                      │      │  - Pub/Sub           │    │
│  └──────────────────────┘      └──────────────────────┘    │
│           │                              │                  │
│           │                              │                  │
│  ┌────────┴──────────────────────────────┴────────────┐    │
│  │              Message Queue (Optional)              │    │
│  │              (Redis / RabbitMQ / AWS SQS)          │    │
│  │                                                    │    │
│  │  - 非同期処理 (メール送信、通知、レポート生成)        │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                      外部サービス層                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  - APNs (Apple Push Notification service) - Phase 2         │
│  - SendGrid / AWS SES (メール通知)                           │
│  - Stripe (決済処理 - オプション)                             │
│  - AWS S3 / Cloud Storage (画像・ドキュメント保存)            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## アーキテクチャの特徴

### 1. マイクロサービス指向の分離設計

**REST APIサーバーとWebSocketサーバーを分離**することで、以下のメリットを実現：

- **独立したスケーリング**: リアルタイム通信の負荷に応じて個別にスケールアウト可能
- **障害の局所化**: 一方のサービス障害が他方に影響しない
- **技術選択の柔軟性**: 各サービスに最適な技術を選択可能

### 2. リアルタイム通信の実装

**WebSocket (Socket.io)** を使用したリアルタイム双方向通信：

- **低レイテンシ**: 入札から通知まで100ms以内の応答
- **永続的接続**: ポーリング不要でサーバーリソースを節約
- **自動再接続**: ネットワーク断時の自動リカバリ
- **ルームベース管理**: オークションごとに独立したチャネル
- **クライアント対応**: Vue.js (Socket.io-client) / iOS Swift (Starscream or Socket.IO-Client-Swift)

### 3. Redis活用による高速性とスケーラビリティ

**Redis** を多目的に活用：

- **セッション管理**: 分散環境でのユーザーセッション共有
- **リアルタイム状態管理**: オークションの残り時間、最高入札額をキャッシュ
- **Pub/Sub**: 複数WebSocketサーバー間でのイベント配信
- **入札キュー**: 同時入札の競合制御と順序保証

### 4. タイマー管理アーキテクチャ

**オークションタイマーの精密な管理**：

```
┌─────────────────────────────────────────────────────┐
│           タイマー管理システム                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. オークション開始時                                │
│     ↓                                               │
│     Redis: SET auction:{id}:end_time {timestamp}    │
│     Redis: SET auction:{id}:extended false          │
│                                                     │
│  2. 毎秒の残り時間計算                                │
│     ↓                                               │
│     remaining = end_time - current_time             │
│     WebSocket: broadcast remaining time             │
│                                                     │
│  3. 入札イベント受信                                  │
│     ↓                                               │
│     IF remaining < 300s (5分) THEN                  │
│       new_end_time = current_time + 300s            │
│       Redis: SET auction:{id}:end_time {new_time}   │
│       Redis: SET auction:{id}:extended true         │
│       WebSocket: broadcast "extended" event         │
│                                                     │
│  4. タイムアウト検知                                  │
│     ↓                                               │
│     IF current_time >= end_time THEN                │
│       オークション終了処理                            │
│       落札者確定                                     │
│       WebSocket: broadcast "ended" event            │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 5. データ整合性とトランザクション

**PostgreSQLとRedisの適材適所な使い分け**：

- **PostgreSQL**: 永続化が必要なマスターデータ、入札履歴、監査ログ
- **Redis**: リアルタイム性が必要な一時データ、キャッシュ
- **トランザクション**: 入札処理時はPostgreSQLトランザクションで整合性保証

### 6. 水平スケーラビリティ

**ステートレス設計**によるスケールアウト対応：

```
┌──────────────────────────────────────────────────┐
│         Load Balancer (Sticky Session)           │
└───────┬──────────────┬──────────────┬───────────┘
        │              │              │
   ┌────┴───┐    ┌────┴───┐    ┌────┴───┐
   │ WS #1  │    │ WS #2  │    │ WS #3  │
   └────┬───┘    └────┬───┘    └────┬───┘
        │              │              │
        └──────────────┴──────────────┘
                       │
              ┌────────┴────────┐
              │  Redis Pub/Sub  │  ← イベント配信
              └─────────────────┘
```

## データフロー

### 入札処理フロー

```
┌──────────┐
│  Client  │
└─────┬────┘
      │ 1. bid event (WebSocket)
      ↓
┌─────────────────┐
│ WebSocket Server│
└─────┬───────────┘
      │ 2. validate connection & auth
      ↓
┌─────────────────┐
│ Business Logic  │
└─────┬───────────┘
      │ 3. validate bid (amount, timing)
      ↓
┌─────────────────┐
│   PostgreSQL    │ ← 4. INSERT bid record
└─────────────────┘
      │
      │ 5. update auction state
      ↓
┌─────────────────┐
│     Redis       │ ← 6. update cache & timer
└─────┬───────────┘
      │ 7. publish event
      ↓
┌─────────────────┐
│   Redis Pub/Sub │
└─────┬───────────┘
      │ 8. broadcast to all WS servers
      ↓
┌──────────────────────────────────┐
│  All WebSocket Server Instances  │
└─────┬────────────────────────────┘
      │ 9. emit to clients in room
      ↓
┌──────────────────────────────┐
│  All Connected Clients       │ ← 10. UI update
└──────────────────────────────┘
```

### オークション開始フロー

```
管理者
  │
  │ 1. POST /api/auctions/:id/start
  ↓
REST API Server
  │
  │ 2. validate permissions
  │ 3. update auction status = "active"
  ↓
PostgreSQL
  │
  ↓
Redis
  │ 4. SET auction:{id}:end_time
  │ 5. SET auction:{id}:status "active"
  ↓
Redis Pub/Sub
  │ 6. PUBLISH auction:started {auction_id}
  ↓
WebSocket Servers
  │ 7. broadcast to all connected clients
  │ 8. start timer countdown
  ↓
All Clients
  │ 9. show auction UI with timer
```

## セキュリティ設計

### 認証・認可

1. **JWT (JSON Web Token)** による認証
   - アクセストークン (短期: 15分)
   - リフレッシュトークン (長期: 7日)

2. **WebSocket接続の認証**
   - ハンドシェイク時にJWTトークンを検証
   - 接続後も定期的にトークンの有効性をチェック

3. **ロールベースアクセス制御 (RBAC)**
   - `admin`: 全権限
   - `auctioneer`: オークション管理・開始・終了
   - `bidder`: 入札のみ
   - `viewer`: 閲覧のみ

### データ保護

- **通信の暗号化**: TLS 1.3 (HTTPS/WSS)
- **パスワードハッシュ化**: bcrypt (cost factor: 12)
- **APIレート制限**: IPアドレスごとに 100 req/min
- **入札レート制限**: ユーザーごとに 10 bids/min

### 不正防止

- **二重入札防止**: Redisロックによる排他制御
- **入札額検証**: 最低入札単位、最高入札額の検証
- **タイムスタンプ検証**: クライアント時刻改ざん防止
- **監査ログ**: 全入札イベントを記録

## パフォーマンス要件

| 項目 | 目標値 |
|------|--------|
| WebSocket接続確立 | < 100ms |
| 入札イベント処理 | < 50ms |
| 入札通知配信 | < 100ms |
| REST API応答時間 | < 200ms (P95) |
| 同時接続数 | 10,000+ connections |
| 同時開催オークション数 | 100+ auctions |
| データベースクエリ | < 50ms (P95) |
| Redisクエリ | < 5ms (P99) |

## 監視・運用

### メトリクス収集

- **APM**: New Relic / Datadog
- **ログ集約**: ELK Stack / CloudWatch Logs
- **メトリクス**: Prometheus + Grafana

### 重要な監視項目

1. **WebSocket接続数**: アクティブ接続数の推移
2. **入札レート**: 秒間入札数
3. **応答時間**: エンドツーエンドのレイテンシ
4. **エラー率**: 4xx, 5xxエラーの発生率
5. **Redis/DB接続プール**: 使用率と待機時間
6. **CPU/メモリ使用率**: リソース使用状況

### アラート設定

- WebSocket切断率が10%を超えた場合
- 入札処理の失敗率が5%を超えた場合
- API応答時間が500msを超えた場合
- データベース接続プールが90%を超えた場合

## デプロイ構成

### 推奨環境: AWS

```
┌────────────────────────────────────────────────────────┐
│                     AWS Cloud                          │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │     CloudFront (CDN)                         │    │
│  │     - Static assets caching                  │    │
│  │     - DDoS protection                        │    │
│  └──────────────────┬───────────────────────────┘    │
│                     │                                 │
│  ┌──────────────────┴───────────────────────────┐    │
│  │  Application Load Balancer                   │    │
│  │  - SSL termination                           │    │
│  │  - Path-based routing                        │    │
│  │  - Health checks                             │    │
│  └──────────────────┬───────────────────────────┘    │
│                     │                                 │
│         ┌───────────┴───────────┐                    │
│         │                       │                    │
│  ┌──────┴──────┐         ┌─────┴──────┐            │
│  │   ECS/Fargate         │   ECS/Fargate            │
│  │   (REST API)  │         │ (WebSocket) │            │
│  │   Auto Scaling│         │ Auto Scaling│            │
│  └──────┬──────┘         └─────┬──────┘            │
│         │                       │                    │
│         └───────────┬───────────┘                    │
│                     │                                 │
│  ┌──────────────────┴───────────────────────────┐    │
│  │  ElastiCache for Redis (Cluster Mode)       │    │
│  │  - Multi-AZ                                  │    │
│  │  - Automatic failover                        │    │
│  └──────────────────────────────────────────────┘    │
│                                                        │
│  ┌────────────────────────────────────────────┐      │
│  │  RDS for PostgreSQL                        │      │
│  │  - Multi-AZ deployment                     │      │
│  │  - Read replicas                           │      │
│  │  - Automated backups                       │      │
│  └────────────────────────────────────────────┘      │
│                                                        │
│  ┌────────────────────────────────────────────┐      │
│  │  S3                                        │      │
│  │  - Static assets                           │      │
│  │  - Auction images                          │      │
│  │  - Logs & backups                          │      │
│  └────────────────────────────────────────────┘      │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 代替環境: GCP / 自前VPS

- **GCP**: Cloud Run + Cloud SQL + Memorystore
- **自前VPS**: Docker Swarm / Kubernetes + NGINX + PostgreSQL + Redis

## 拡張性・将来対応

1. **マルチテナント対応**: 複数の主催者が独立してオークションを開催
2. **ビデオストリーミング**: 競走馬の映像をライブ配信
3. **AIレコメンデーション**: 過去の入札履歴から興味のある馬を推薦
4. **ブロックチェーン**: 入札履歴の改ざん防止と透明性確保
5. **国際化**: 多言語・多通貨対応

## まとめ

本アーキテクチャは以下の要件を満たします：

✅ **リアルタイム性**: WebSocketによる双方向通信で瞬時の入札反映  
✅ **5分タイマー + 延長**: Redisベースの精密なタイマー管理  
✅ **スケーラビリティ**: ステートレス設計で水平スケール可能  
✅ **可用性**: Multi-AZ構成と自動フェイルオーバー  
✅ **セキュリティ**: JWT認証、TLS暗号化、レート制限  
✅ **マルチプラットフォーム**:  
   - **Phase 1**: Web (Vue.js 3 + Vite) - レスポンシブ対応  
   - **Phase 2**: iOS App (Swift + SwiftUI) - ネイティブアプリ

競走馬セリの要件に最適化された、エンタープライズグレードのアーキテクチャです。

## フェーズ別開発計画

### Phase 1: Webアプリケーション (優先)

**目的**: 全ユーザー向けの基本機能を提供

**技術スタック**
- **フロントエンド**: Vue.js 3 (Composition API) + Vite
- **UIフレームワーク**: Vuetify 3 / Element Plus / Ant Design Vue
- **状態管理**: Pinia
- **WebSocket**: Socket.io-client
- **HTTP Client**: Axios
- **認証**: JWT (localStorage/sessionStorage)

**対応機能**
- オークション一覧・詳細閲覧
- リアルタイム入札
- 管理画面 (オークション作成・管理)
- ユーザー登録・認証
- レスポンシブデザイン (モバイルブラウザ対応)

**配信方法**
- CloudFront + S3 (静的ホスティング)
- PWA対応でモバイルでもアプリライクな体験

### Phase 2: iOSネイティブアプリ (将来)

**目的**: 入札者向けの専用アプリで最高のUXを提供

**技術スタック**
- **言語**: Swift 5+
- **UIフレームワーク**: SwiftUI
- **アーキテクチャ**: MVVM + Combine
- **WebSocket**: Starscream または Socket.IO-Client-Swift
- **HTTP Client**: URLSession / Alamofire
- **認証**: Keychain による安全なトークン保存
- **プッシュ通知**: APNs (Apple Push Notification service)

**追加機能**
- プッシュ通知 (オークション開始・入札通知)
- オフライン時の入札キュー
- Face ID / Touch ID 認証
- ウィジェット対応 (進行中オークションの表示)
- Apple Watch対応 (Phase 2.1)

**配信方法**
- App Store配信
- TestFlight によるベータテスト
