# 入札者登録画面(1.2.5)実装プラン

**作成日**: 2025年11月22日
**対象画面**: 入札者登録画面（Bidder Registration）
**パス**: `/admin/bidders/new`
**権限**: system_admin
**優先度**: 高（フェーズ2: 管理機能拡充）

---

## 1. 概要

### 1.1 目的
システム管理者が新規入札者アカウントを作成するための画面です。メールアドレス、パスワード、表示名、初期ポイントを入力することで、新規入札者アカウントを登録します。

### 1.2 対象ユーザー
- **system_admin（システム管理者）のみ**: システム管理者のみがこの画面にアクセスできます
- auctioneersは入札者を作成する権限を持ちません

### 1.3 主要機能
1. 入札者情報の入力フォーム（メールアドレス、パスワード、表示名、初期ポイント）
2. 入力内容のバリデーション（検証）
3. 重複チェック（メールアドレスの一意性確認）
4. パスワード強度チェックとハッシュ化
5. UUID自動生成（入札者IDとして使用）
6. bidder_pointsレコード作成（バックエンドで手動作成）
7. 初期ポイント設定（指定時のみ、未指定時は0）
8. point_historyレコード作成（初期ポイント > 0の場合のみ、バックエンドで手動作成）
9. 登録実行
10. エラーメッセージの表示
11. 登録成功後の入札者一覧への自動遷移

---

## 2. 画面レイアウト

### 2.1 画面構成

```
┌──────────────────────────────────────────────────┐
│  [← 入札者一覧に戻る]                                 │
├──────────────────────────────────────────────────┤
│                                                  │
│  新規入札者登録                                      │
│                                                  │
│  ┌─────────────────────────────────────┐        │
│  │  [エラーメッセージ表示エリア]           │        │
│  └─────────────────────────────────────┘        │
│                                                  │
│  基本情報                                          │
│  ─────────────────────────────────────          │
│                                                  │
│  メールアドレス *                                   │
│  [_________________________________]             │
│  [フィールドエラー]                                 │
│                                                  │
│  表示名                                            │
│  [_________________________________]             │
│  [フィールドエラー]                                 │
│  任意。未入力の場合はメールアドレスが使用されます。      │
│                                                  │
│                                                  │
│  認証情報                                          │
│  ─────────────────────────────────────          │
│                                                  │
│  パスワード *                                      │
│  [_________________________________]             │
│  [フィールドエラー]                                 │
│  8文字以上で入力してください。                        │
│                                                  │
│  パスワード（確認） *                                │
│  [_________________________________]             │
│  [フィールドエラー]                                 │
│  確認のため、もう一度入力してください。                 │
│                                                  │
│                                                  │
│  ポイント設定                                       │
│  ─────────────────────────────────────          │
│                                                  │
│  初期ポイント                                       │
│  [_________________________________]             │
│  [フィールドエラー]                                 │
│  任意。登録時に付与するポイント数を入力します。          │
│  0以上の整数で入力してください。                       │
│                                                  │
│                                                  │
│  [ キャンセル ]  [    登録する    ]                 │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 2.2 デザイン要件
- **レイアウト**: 左側にサイドバーナビゲーション、右側にフォームエリア
- **フォーム幅**: 最大600px、画面中央に配置
- **セクション区切り**: 「基本情報」「認証情報」「ポイント設定」で視覚的に区切る
- **必須項目**: ラベルに`*`マークを表示
- **ヘルプテキスト**: フィールドの下に小さいフォントで説明を表示
- **ボタン配置**: フォームの下部に配置、登録ボタンを右側に配置
- **エラー**: 赤い枠線と赤いテキストで表示
- **成功メッセージ**: 登録後はリダイレクト前に一瞬トーストで表示

---

## 3. 入力項目とバリデーション

### 3.1 メールアドレス

| 項目 | 内容 |
|------|------|
| **ラベル** | メールアドレス |
| **入力形式** | テキスト入力（email type） |
| **プレースホルダー** | bidder@example.com |
| **必須/任意** | 必須 |
| **最大文字数** | 255文字 |

**バリデーションルール:**
1. 空欄の場合: 「メールアドレスを入力してください」
2. メール形式でない場合: 「メールアドレスの形式が正しくありません」
   - 例: `@`が含まれていない、`.`が含まれていない
3. 重複チェック（API呼び出し）: 「このメールアドレスは既に登録されています」

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）で形式チェック
- 送信時: 登録ボタンをクリックした時に重複チェック

---

### 3.2 表示名

| 項目 | 内容 |
|------|------|
| **ラベル** | 表示名 |
| **入力形式** | テキスト入力（text type） |
| **プレースホルダー** | 入札者01 |
| **必須/任意** | 任意 |
| **最大文字数** | 100文字 |

**バリデーションルール:**
1. 100文字を超える場合: 「表示名は100文字以内で入力してください」
2. 空欄の場合: バリデーションエラーなし（任意項目）

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）

**ヘルプテキスト:**
「任意。未入力の場合はメールアドレスが使用されます。」

---

### 3.3 パスワード

| 項目 | 内容 |
|------|------|
| **ラベル** | パスワード |
| **入力形式** | パスワード入力（****で表示） |
| **プレースホルダー** | 8文字以上 |
| **必須/任意** | 必須 |
| **最小文字数** | 8文字 |

**バリデーションルール:**
1. 空欄の場合: 「パスワードを入力してください」
2. 8文字未満の場合: 「パスワードは8文字以上で入力してください」

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）
- 送信時: 登録ボタンをクリックした時

**ヘルプテキスト:**
「8文字以上で入力してください。」

---

### 3.4 パスワード（確認）

| 項目 | 内容 |
|------|------|
| **ラベル** | パスワード（確認） |
| **入力形式** | パスワード入力（****で表示） |
| **プレースホルダー** | 確認のため再度入力 |
| **必須/任意** | 必須 |
| **最小文字数** | 8文字 |

**バリデーションルール:**
1. 空欄の場合: 「確認用パスワードを入力してください」
2. パスワードと一致しない場合: 「パスワードが一致しません」

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）
- リアルタイム: パスワードフィールドが変更された時にも再検証

**ヘルプテキスト:**
「確認のため、もう一度入力してください。」

---

### 3.5 初期ポイント

| 項目 | 内容 |
|------|------|
| **ラベル** | 初期ポイント |
| **入力形式** | 数値入力（number type） |
| **プレースホルダー** | 1000 |
| **必須/任意** | 任意 |
| **デフォルト値** | 空欄（0ポイント） |
| **最小値** | 0 |
| **最大値** | 9223372036854775807（BIGINT最大値） |

**バリデーションルール:**
1. 空欄の場合: バリデーションエラーなし（0ポイントとして扱う）
2. 負の数の場合: 「0以上の整数を入力してください」
3. 数値以外の場合: 「数値を入力してください」
4. 小数の場合: 「整数で入力してください」

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）
- 送信時: 登録ボタンをクリックした時

**ヘルプテキスト:**
「任意。登録時に付与するポイント数を入力します。0以上の整数で入力してください。」

---

## 4. 処理フロー

### 4.1 登録処理の流れ

```
[ユーザー操作]
  ↓
1. 各フィールドに情報を入力
  ↓
2. 登録ボタンをクリック
  ↓
3. フロントエンドで入力内容を検証
   - 全フィールドのバリデーション実行
   - エラーがあれば処理を中断、エラー表示
  ↓
4. バックエンドAPIに登録リクエストを送信
  ↓
5. バックエンドで登録処理を実行
   - メールアドレスの重複チェック
   - UUID自動生成（入札者ID）
   - パスワードのbcryptハッシュ化
   - データベーストランザクション開始
     a. biddersテーブルに新規レコード挿入
        - status = 'active'で作成
        - UUIDを取得
     b. bidder_pointsレコードを手動で作成
        - bidder_id = 新規作成した入札者のUUID
        - total_points = 初期ポイント数（未指定時は0）
        - available_points = 初期ポイント数（未指定時は0）
        - reserved_points = 0
     c. 初期ポイントが指定されている場合（0より大きい場合）
        - point_historyレコードを手動で作成
          * type = 'grant'
          * amount = 初期ポイント数
          * balance_before = 0, balance_after = 初期ポイント数
          * total_before = 0, total_after = 初期ポイント数
          * reserved_before = 0, reserved_after = 0
          * admin_id = 登録を実行した管理者のID
          * note = '初期ポイント付与'
   - トランザクションコミット
  ↓
6. 登録成功の場合
   - 新規作成された入札者情報を返却
  ↓
7. フロントエンドで成功処理
   - 成功トーストメッセージを表示
   - 入札者一覧画面へリダイレクト
```

### 4.2 登録失敗時の処理

| 失敗理由 | 表示メッセージ | HTTPステータス |
|---------|--------------|--------------|
| メールアドレスが既に登録されている | このメールアドレスは既に登録されています | 409 |
| バリデーションエラー | 入力内容に誤りがあります。各フィールドをご確認ください。 | 400 |
| 権限不足（ロールがsystem_adminでない） | この操作を行う権限がありません | 403 |
| 初期ポイントが負の数 | 初期ポイントは0以上で入力してください | 400 |
| サーバーエラー | 登録に失敗しました。もう一度お試しください。 | 500 |
| ネットワークエラー | サーバーに接続できません | - |

---

## 5. セキュリティ要件

### 5.1 パスワードの取り扱い

1. **ハッシュ化**
   - データベースにはパスワードを平文で保存しない
   - bcryptアルゴリズムでハッシュ化してから保存
   - ハッシュ化コスト: 10（セキュリティと速度のバランス）

2. **パスワード強度チェック**
   - 最小8文字以上
   - （将来実装）大文字・小文字・数字・記号の組み合わせチェック

### 5.2 認証・認可

1. **JWT認証**
   - この画面へのアクセスには有効なJWTトークンが必要
   - トークンの検証はミドルウェアで実行

2. **ロール検証**
   - system_adminロールのみアクセス可能
   - auctioneersがアクセスした場合は403エラー

3. **入力サニタイゼーション**
   - ユーザー入力はすべてエスケープ処理
   - SQLインジェクション対策（ORMのプレースホルダー使用）
   - XSS対策（Vueフレームワークの自動保護）

### 5.3 データ整合性

1. **メールアドレスのユニーク性**
   - データベースレベルでユニーク制約（論理削除を除く）
   - APIレベルで重複チェック
   - フロントエンドでもリアルタイムチェック（オプション）

2. **UUIDの自動生成**
   - データベースレベルで`gen_random_uuid()`関数を使用
   - 衝突の可能性は実質ゼロ
   - 予測不可能なID（セキュリティ向上）

3. **ポイントの制約**
   - 0以上の整数のみ許可
   - データベースレベルでCHECK制約
   - available_points + reserved_points <= total_pointsの整合性保証

4. **トランザクション管理**
   - 入札者レコードの挿入とポイント付与は単一トランザクション内で実行
   - エラー時は自動ロールバック

---

## 6. データベース設計

### 6.1 入札者テーブル（bidders）

このテーブルには既に以下のカラムが定義されています（マイグレーション001で作成済み）:

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| id | UUID | 入札者ID（UUID自動生成） | 主キー、デフォルト: gen_random_uuid() |
| email | VARCHAR(255) | メールアドレス | 必須、ユニーク（論理削除を除く）、メール形式 |
| password_hash | VARCHAR(255) | パスワードハッシュ | 必須 |
| display_name | VARCHAR(100) | 表示名 | 任意 |
| status | VARCHAR(20) | アカウント状態 | 必須、active / suspended / deleted |
| created_at | TIMESTAMPTZ | 作成日時 | 自動設定 |
| updated_at | TIMESTAMPTZ | 更新日時 | 自動更新 |

### 6.2 入札者ポイントテーブル（bidder_points）

このテーブルには既に以下のカラムが定義されています（マイグレーション001で作成済み）:

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| bidder_id | UUID | 入札者ID | 主キー、外部キー（bidders.id） |
| total_points | BIGINT | 累計ポイント | 必須、デフォルト: 0、0以上 |
| available_points | BIGINT | 利用可能ポイント | 必須、デフォルト: 0、0以上 |
| reserved_points | BIGINT | 予約中ポイント | 必須、デフォルト: 0、0以上 |
| updated_at | TIMESTAMPTZ | 更新日時 | 自動更新 |

**制約:**
- `CHECK (total_points >= 0 AND available_points >= 0 AND reserved_points >= 0)`
- `CHECK (available_points + reserved_points <= total_points)`

### 6.3 ポイント履歴テーブル（point_history）

ポイント変更時に記録します:

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | BIGSERIAL | 履歴ID |
| bidder_id | UUID | 入札者ID |
| amount | BIGINT | 変動ポイント数（正負） |
| type | VARCHAR(50) | 操作種別（grant/reserve/release/consume/refund） |
| balance_before | BIGINT | 変更前の利用可能ポイント |
| balance_after | BIGINT | 変更後の利用可能ポイント |
| reserved_before | BIGINT | 変更前の予約中ポイント |
| reserved_after | BIGINT | 変更後の予約中ポイント |
| total_before | BIGINT | 変更前の累計ポイント |
| total_after | BIGINT | 変更後の累計ポイント |
| related_auction_id | BIGINT | 関連オークションID（任意） |
| admin_id | BIGINT | 操作した管理者ID（任意） |
| note | TEXT | メモ（任意） |
| created_at | TIMESTAMPTZ | 記録日時 |

### 6.4 新規登録時のデフォルト値

| カラム | デフォルト値 |
|-------|------------|
| id | gen_random_uuid()（UUID自動生成） |
| status | 'active' |
| created_at | 現在時刻 |
| updated_at | 現在時刻 |
| display_name | NULL（未入力の場合） |

### 6.5 トリガーの廃止と手動作成（重要）

**注意**: すべてのトリガーは削除済み、または削除予定です。

1. **bidder_pointsの手動作成（重要）**
   - ~~トリガー `trigger_create_bidder_points` は削除予定~~
   - **バックエンドで明示的にbidder_pointsレコードを作成する必要があります**
   - 入札者作成時に以下の情報でレコードを作成:
     * bidder_id = 新規作成した入札者のUUID
     * total_points = 初期ポイント数（未指定時は0）
     * available_points = 初期ポイント数（未指定時は0）
     * reserved_points = 0

2. **point_historyの手動作成（重要）**
   - **注意**: マイグレーション007でpoint_history自動記録トリガーは削除されています
   - bidder_pointsテーブルが更新されても、point_historyレコードは自動作成されません
   - **バックエンドで明示的にpoint_historyレコードを作成する必要があります**
   - 初期ポイントが0より大きい場合のみ、以下の情報でレコードを作成:
     * type = 'grant'
     * amount = 付与ポイント数（正の数）
     * balance_before = 0, balance_after = 付与ポイント数
     * total_before = 0, total_after = 付与ポイント数
     * reserved_before = 0, reserved_after = 0
     * admin_id = 登録を実行した管理者のID
     * note = '初期ポイント付与'

---

## 7. API仕様

### 7.1 入札者登録API

**エンドポイント**: `POST /api/admin/bidders`

**認証**: 必須（JWT、system_adminロール）

**リクエスト形式**:
```
POST /api/admin/bidders
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "email": "bidder@example.com",
  "password": "password123",
  "display_name": "入札者01",
  "initial_points": 1000
}
```

**リクエストボディフィールド**:
| フィールド | 型 | 必須 | 説明 |
|-----------|------|------|------|
| email | string | ○ | メールアドレス（255文字以内） |
| password | string | ○ | パスワード（8文字以上） |
| display_name | string | × | 表示名（100文字以内） |
| initial_points | integer | × | 初期ポイント（0以上、デフォルト: 0） |

**レスポンス形式（成功時）**:
```
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "bidder@example.com",
  "display_name": "入札者01",
  "status": "active",
  "points": {
    "total_points": 1000,
    "available_points": 1000,
    "reserved_points": 0
  },
  "created_at": "2025-11-22T10:30:00Z",
  "updated_at": "2025-11-22T10:30:00Z"
}
```

**レスポンス形式（失敗時）**:
```
HTTP/1.1 409 Conflict
Content-Type: application/json

{
  "error": "Email already exists"
}
```

### 7.2 エラーレスポンス一覧

| HTTPステータス | エラーメッセージ | 発生条件 |
|--------------|----------------|---------|
| 400 Bad Request | Invalid request body | リクエストボディの形式が不正 |
| 400 Bad Request | Email is required | メールアドレスが未入力 |
| 400 Bad Request | Invalid email format | メールアドレスの形式が不正 |
| 400 Bad Request | Password is required | パスワードが未入力 |
| 400 Bad Request | Password must be at least 8 characters | パスワードが8文字未満 |
| 400 Bad Request | Initial points must be non-negative | 初期ポイントが負の数 |
| 400 Bad Request | Initial points must be an integer | 初期ポイントが整数でない |
| 401 Unauthorized | Unauthorized | JWT認証失敗 |
| 403 Forbidden | Insufficient permissions | ロールがsystem_adminでない |
| 409 Conflict | Email already exists | メールアドレスが既に登録されている |
| 500 Internal Server Error | Internal server error | サーバー内部エラー |

### 7.3 メールアドレス重複チェックAPI（オプション）

**エンドポイント**: `GET /api/admin/bidders/check-email?email=<EMAIL>`

**認証**: 必須（JWT、system_adminロール）

**リクエスト形式**:
```
GET /api/admin/bidders/check-email?email=test@example.com
Authorization: Bearer <JWT_TOKEN>
```

**レスポンス形式**:
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "available": false,
  "message": "Email already exists"
}
```

---

## 8. バックエンド実装要件

### 8.1 レイヤー構成

バックエンドは以下の4層構造で実装します:

1. **Domain層（データモデル）**
   - 入札者情報の構造定義
   - 入札者登録リクエストの構造定義
   - 入札者レスポンスの構造定義
   - ポイント情報の構造定義

2. **Repository層（データアクセス）**
   - 入札者の新規作成（INSERT bidders）
   - メールアドレスでの検索（重複チェック）
   - ポイントレコードの作成（INSERT bidder_points）
   - ポイント履歴の作成（INSERT point_history）
   - トランザクション管理

3. **Service層（ビジネスロジック）**
   - 入札者登録処理の実装
   - メールアドレス重複チェック
   - パスワードのbcryptハッシュ化
   - 入力バリデーション
   - display_nameのデフォルト処理（未入力時はNULL）
   - bidder_pointsレコード作成（初期ポイント設定）
   - ポイント履歴レコード作成（初期ポイント > 0の場合のみ、type='grant'）
   - トランザクション制御（入札者作成→ポイントレコード作成→履歴記録）

4. **Handler層（APIエンドポイント）**
   - HTTPリクエストの受け取り
   - リクエストボディのバリデーション
   - Service層の呼び出し
   - HTTPレスポンスの返却（201 Created）
   - エラーハンドリング

### 8.2 登録処理の詳細

全てトランザクション内で実行する処理の流れ:

1. **入札者レコードを作成**
   ```
   INSERT INTO bidders (email, password_hash, display_name, status)
   VALUES (?, ?, ?, 'active')
   RETURNING id
   ```

2. **bidder_pointsレコードを手動で作成**（重要: トリガーは削除予定）
   ```
   INSERT INTO bidder_points (
     bidder_id,
     total_points,
     available_points,
     reserved_points
   ) VALUES (
     ?,  -- 新規作成した入札者のUUID
     COALESCE(initial_points, 0),  -- 初期ポイント（未指定時は0）
     COALESCE(initial_points, 0),  -- 利用可能ポイント
     0   -- 予約中ポイント
   )
   ```

3. **point_historyレコードを手動で作成**（初期ポイント > 0の場合のみ）
   ```
   -- 初期ポイントが0より大きい場合のみ実行
   IF initial_points > 0 THEN
     INSERT INTO point_history (
       bidder_id, amount, type,
       balance_before, balance_after,
       reserved_before, reserved_after,
       total_before, total_after,
       admin_id, note
     ) VALUES (
       ?,  -- 入札者のUUID
       initial_points,  -- 付与ポイント数（正の数）
       'grant',  -- 操作種別
       0, initial_points,  -- 利用可能ポイント（前/後）
       0, 0,  -- 予約中ポイント（前/後）
       0, initial_points,  -- 累計ポイント（前/後）
       admin_id,  -- 管理者ID
       '初期ポイント付与'  -- メモ
     )
   END IF
   ```

**注意事項:**
- **bidder_pointsの自動作成トリガーは削除予定**です。バックエンドで必ず作成してください
- **point_historyの自動記録トリガーは削除済み**です。バックエンドで必ず作成してください
- admin_idには登録を実行した管理者のIDをJWTトークンから取得して設定します
- 初期ポイントが0または未指定の場合は、point_historyレコードを作成しません（bidder_pointsは作成）
- トランザクション内で全ての操作を実行し、エラー時は自動ロールバックされます

### 8.3 ミドルウェア

1. **JWT認証ミドルウェア**
   - リクエストヘッダーからトークンを取得
   - トークンの有効性を検証
   - トークンからユーザー情報を抽出
   - 認証失敗時は401エラーを返す

2. **ロール検証ミドルウェア**
   - ユーザーのロールを確認
   - system_adminロールであることを検証
   - 権限不足の場合は403エラーを返す

### 8.4 使用技術

- **フレームワーク**: Gin（HTTPルーティング）
- **ORM**: GORM（データベースアクセス）
- **パスワードハッシュ**: bcryptライブラリ
- **バリデーション**: go-playground/validator（構造体タグベース）
- **UUID**: Google UUID library（UUIDパース・検証）

---

## 9. フロントエンド実装要件

### 9.1 ディレクトリ構成

```
frontend/src/
  views/
    admin/
      BidderRegistrationView.vue    # 入札者登録画面コンポーネント
  components/
    ui/                             # UIコンポーネント（Shadcn Vue）
      button.vue                    # ボタン
      input.vue                     # 入力フィールド
      label.vue                     # ラベル
      card.vue                      # カード
      alert.vue                     # エラー表示
      separator.vue                 # セクション区切り線
  services/
    api/
      bidderApi.ts                  # 入札者API呼び出し
  utils/
    validation.ts                   # バリデーション関数
  router/
    index.ts                        # ルーティング設定
```

### 9.2 実装コンポーネント

1. **入札者登録画面（BidderRegistrationView.vue）**
   - メールアドレス入力フィールド
   - 表示名入力フィールド
   - パスワード入力フィールド
   - パスワード確認入力フィールド
   - 初期ポイント入力フィールド
   - 登録ボタン
   - キャンセルボタン（入札者一覧へ戻る）
   - エラーメッセージ表示エリア
   - バリデーション処理
   - API呼び出し

2. **入札者API Client（bidderApi.ts）**
   - 入札者登録API呼び出し
   - メールアドレス重複チェックAPI呼び出し（オプション）
   - HTTPリクエスト/レスポンスの処理
   - エラーハンドリング

3. **バリデーション関数（validation.ts）**
   - メールアドレス形式チェック
   - パスワード強度チェック
   - パスワード一致チェック
   - 文字数制限チェック
   - 数値範囲チェック
   - 必須項目チェック

4. **ルーティング設定（router/index.ts）**
   - `/admin/bidders/new`へのルート定義
   - 認証ガード（未認証時のリダイレクト）
   - ロール検証ガード（system_adminのみアクセス可能）

### 9.3 使用技術

- **フレームワーク**: Vue 3（Composition API、`<script setup>`）
- **UIライブラリ**: Shadcn Vue + Tailwind CSS
- **状態管理**: Pinia（必要に応じて）
- **HTTP Client**: Axios
- **ルーティング**: Vue Router
- **フォームバリデーション**: VeeValidate（オプション）

---

## 10. 画面遷移

### 10.1 遷移パターン

```
[入札者一覧画面]
  ↓
  新規登録ボタンクリック
  ↓
/admin/bidders/new（入札者登録画面）
  ↓
  ┌─ 登録成功
  │  ↓
  │  成功トーストメッセージ表示
  │  ↓
  │  /admin/bidders（入札者一覧画面）
  │
  └─ キャンセルボタンクリック
     ↓
     /admin/bidders（入札者一覧画面）
```

### 10.2 認証ガードの動作

1. **未認証ユーザーがアクセスした場合**
   - `/admin/login`へ自動リダイレクト

2. **認証済みでもロールがsystem_adminでない場合**
   - `/admin/dashboard`へ自動リダイレクト
   - エラートーストメッセージ: 「この操作を行う権限がありません」

3. **トークンの有効期限が切れた場合**
   - `/admin/login`へ自動リダイレクト
   - エラーメッセージ: 「セッションの有効期限が切れました。再度ログインしてください。」

---

## 11. UIの動作仕様

### 11.1 通常時の動作

1. **初期表示**
   - すべてのフィールドが空の状態
   - 初期ポイントフィールドは空欄（0ポイント）
   - 登録ボタンは有効

2. **入力中**
   - フィールドにフォーカスが当たると枠線がハイライト
   - パスワードフィールドは****で表示
   - 初期ポイントは数値のみ入力可能

3. **フィールドからフォーカスが外れた時**
   - バリデーションを実行
   - エラーがあればフィールドの下に赤いテキストで表示
   - エラーがあればフィールドの枠線が赤くなる

4. **初期ポイント入力時**
   - 数値以外の入力は受け付けない
   - 負の数の場合はエラー表示
   - 小数点の場合はエラー表示

### 11.2 登録処理中の動作

1. **登録ボタンをクリックした時**
   - すべてのフィールドのバリデーションを実行
   - エラーがあれば処理を中断、最初のエラーフィールドにフォーカス

2. **API通信中**
   - 登録ボタンが無効化される
   - ボタンのテキストが「登録中...」に変わる
   - ボタンにローディングスピナーが表示される
   - すべてのフィールドが無効化される（入力不可）

3. **登録成功時**
   - 成功トーストメッセージを表示: 「入札者を登録しました」
   - 入札者一覧画面へリダイレクト

4. **登録失敗時**
   - フォームの上部に赤い背景のエラーメッセージを表示
   - ボタンとフィールドが再び有効化される
   - メールアドレス重複エラーの場合はメールアドレスフィールドに焦点を当てる

### 11.3 キーボード操作

1. **Tabキー**
   - フィールド間を順に移動
   - 移動順: メールアドレス → 表示名 → パスワード → パスワード確認 → 初期ポイント → 登録ボタン

2. **Enterキー**
   - 初期ポイントフィールドでEnterを押すと登録実行

3. **Escapeキー**
   - 確認モーダルが表示されている場合は閉じる
   - それ以外の場合は何もしない

---

## 12. レスポンシブデザイン

### 12.1 PC（1280px以上）

- フォーム幅: 最大600px、画面中央に配置
- 左側にサイドバーナビゲーション
- ボタン: 右側に配置、幅は自動

### 12.2 タブレット（768px - 1279px）

- フォーム幅: 画面幅の80%
- ハンバーガーメニュー
- ボタン: 下部に配置、幅いっぱい

### 12.3 スマートフォン（767px以下）

- フォーム幅: 画面幅の100%（左右パディング16px）
- ハンバーガーメニュー
- ボタン: 下部に固定配置、幅いっぱい
- セクション区切り線の余白を縮小

---

## 13. アクセシビリティ

### 13.1 キーボード操作

- Tabキー: フィールド間の移動
- Enterキー: 登録実行（初期ポイントフィールドから）
- Escapeキー: モーダルを閉じる

### 13.2 スクリーンリーダー対応

- すべての入力フィールドにラベルを関連付け（`<label for="...">`）
- エラーメッセージをaria-liveで通知
- 必須項目にaria-required="true"を設定
- ヘルプテキストにaria-describedbyを設定

### 13.3 フォーカス表示

- キーボードでフォーカスした要素を明確に表示
- フォーカスリングの色: 青系（高コントラスト）
- タブインデックスを適切に設定（カスタム順序は避ける）

---

## 14. テスト要件

### 14.1 バックエンドテスト

1. **正常系テスト**
   - 有効なデータで入札者を登録できること
   - UUIDが自動生成されること
   - display_nameが未入力の場合、NULLで登録されること
   - パスワードがbcryptでハッシュ化されること
   - statusが'active'で作成されること
   - bidder_pointsレコードがバックエンドで作成されること
   - 初期ポイント未指定時、bidder_pointsが0で作成されること
   - 初期ポイント指定時、bidder_pointsに正しく設定されること
   - point_historyレコードが手動で作成されること（初期ポイント > 0の場合、type='grant'）
   - point_historyに正しいadmin_idが設定されること
   - 初期ポイントが0の場合、point_historyレコードが作成されないこと
   - レスポンスに新規作成された入札者情報とポイント情報が含まれること

2. **異常系テスト**
   - メールアドレス重複時に409エラーが返ること
   - メールアドレスが未入力時に400エラーが返ること
   - メールアドレスの形式が不正時に400エラーが返ること
   - パスワードが未入力時に400エラーが返ること
   - パスワードが8文字未満時に400エラーが返ること
   - 初期ポイントが負の数時に400エラーが返ること

3. **認証・認可テスト**
   - JWT認証なしでアクセスした場合に401エラーが返ること
   - ロールがauctioneersの場合に403エラーが返ること
   - system_adminロールの場合に登録できること

4. **セキュリティテスト**
   - パスワードがレスポンスに含まれないこと
   - SQLインジェクションが防止されること
   - XSS攻撃が防止されること

5. **トランザクションテスト**
   - bidder_points作成でエラーが発生した場合、入札者レコードもロールバックされること
   - point_history作成でエラーが発生した場合、入札者レコードとbidder_pointsもロールバックされること
   - bidder_pointsとpoint_historyの整合性が保たれること
   - トランザクション内で全ての操作が完全に実行されるか、全くされないこと（ACID特性）

### 14.2 フロントエンドテスト

1. **コンポーネントテスト**
   - 登録画面が正しくレンダリングされること
   - 各フィールドのバリデーションが正しく動作すること
   - エラーメッセージが正しく表示されること
   - ローディング状態が正しく表示されること

2. **統合テスト**
   - 登録成功時に入札者一覧へリダイレクトされること
   - 登録失敗時にエラーメッセージが表示されること
   - キャンセルボタンで入札者一覧へ戻ること

3. **バリデーションテスト**
   - メールアドレス形式チェックが正しく動作すること
   - パスワード強度チェックが正しく動作すること
   - パスワード一致チェックが正しく動作すること
   - 初期ポイントの数値チェックが正しく動作すること
   - 必須項目チェックが正しく動作すること

4. **E2Eテスト（将来実装）**
   - 実際のブラウザで登録フローを実行
   - 登録後に入札者一覧に新規入札者が表示されること
   - ポイント残高が正しく表示されること

---

## 15. 環境変数

### 15.1 バックエンド環境変数

`.env`ファイルに以下の設定が必要:

| 変数名 | 説明 | 例 |
|-------|------|-----|
| JWT_SECRET | JWT署名用の秘密鍵（最低32文字） | your-secure-random-secret-key-min-32-chars |
| API_PORT | APIサーバーのポート番号 | 8080 |
| DATABASE_URL | PostgreSQL接続URL | postgres://auction_user:auction_pass@postgres:5432/auction_db |

### 15.2 フロントエンド環境変数

`.env`ファイルに以下の設定が必要:

| 変数名 | 説明 | 例 |
|-------|------|-----|
| VITE_API_BASE_URL | バックエンドAPIのベースURL | http://localhost/api |

---

## 16. 実装手順

### Phase 1: バックエンド基盤（2-3時間）
- [ ] データモデルの定義（BidderCreateRequest, BidderResponse, PointsInfo, BidderPointsCreate, PointHistoryCreate）
- [ ] Repository層の実装（CreateBidder, FindByEmail, CreateBidderPoints, CreatePointHistory）
- [ ] Service層の実装（RegisterBidder、メール重複チェック、パスワードハッシュ化、ポイントレコード作成、履歴記録）
- [ ] バリデーション関数の実装

### Phase 2: バックエンドAPI（1-2時間）
- [ ] Handler層の実装（POST /api/admin/bidders）
- [ ] ルーティング設定（system_adminロール検証ミドルウェア適用）
- [ ] エラーハンドリングの実装
- [ ] 手動テスト（curlまたはPostman）

### Phase 3: フロントエンド基盤（2-3時間）
- [ ] API Clientの実装（bidderApi.ts）
- [ ] バリデーション関数の実装（validation.ts）
- [ ] ルーティング設定（認証ガード、ロール検証ガード）

### Phase 4: フロントエンドUI（3-4時間）
- [ ] Shadcn UIコンポーネントの確認（Separator、Input、Button等）
- [ ] 入札者登録画面コンポーネントの実装
- [ ] フォームバリデーション機能の実装
- [ ] エラーハンドリングの実装
- [ ] ローディング状態の実装

### Phase 5: テストと検証（2-3時間）
- [ ] バックエンドユニットテストの作成
- [ ] フロントエンドコンポーネントテストの作成
- [ ] 統合テストの実施
- [ ] セキュリティ検証（パスワードハッシュ化、認可チェック）
- [ ] トランザクション整合性の検証

**合計想定時間**: 10-15時間

---

## 17. 実装時の注意事項

### 17.1 セキュリティに関する注意

1. **絶対にやってはいけないこと**
   - パスワードを平文でデータベースに保存する
   - パスワードをログに出力する
   - パスワードをレスポンスに含める
   - auctioneersロールに入札者登録権限を付与する
   - UUIDを予測可能な形式で生成する

2. **必ず守ること**
   - パスワードは必ずbcryptでハッシュ化する
   - system_adminロールのみアクセス可能にする
   - メールアドレスはデータベースレベルでユニーク制約をかける
   - UUIDはデータベースの`gen_random_uuid()`関数で生成する
   - エラーメッセージで詳細な情報を漏らさない

### 17.2 データ整合性

1. **データベースの制約**
   - メールアドレスはユニーク制約で重複を防ぐ（論理削除を除く）
   - ステータスは`active`、`suspended`、`deleted`のみ許可
   - ポイントは0以上の整数のみ許可
   - available_points + reserved_points <= total_pointsの制約
   - すべて既にマイグレーション001で定義済み

2. **トランザクション**
   - 入札者レコードの挿入、ポイントレコード作成、履歴記録は単一トランザクション内で実行
   - エラー時は自動ロールバック（全てのレコードが作成されないか、全て作成されるかのどちらか）
   - bidder_pointsとpoint_historyの整合性を保証
   - トランザクションの実行順序:
     1. bidders INSERT（UUID取得）
     2. bidder_points INSERT（初期ポイント設定）
     3. point_history INSERT（初期ポイント > 0の場合のみ）

3. **トリガーの廃止とアプリケーション処理**
   - ~~トリガー `trigger_create_bidder_points` は削除予定~~
   - ~~トリガー `trigger_record_point_history` は削除済み~~
   - **bidder_pointsの作成はアプリケーション側で手動作成する**（トリガーは削除予定）
   - **point_historyの記録はアプリケーション側で手動作成する**（トリガーは削除済み）
   - 初期ポイントが0の場合はpoint_historyレコードを作成しない（bidder_pointsは0で作成）

### 17.3 ユーザビリティ

1. **フィードバック**
   - 登録成功時は明確なメッセージを表示
   - エラー時は具体的な修正方法を示す
   - ローディング状態を視覚的に表示
   - 初期ポイントは任意項目であることを明示

2. **バリデーション**
   - リアルタイムバリデーションで即座にフィードバック
   - 送信前にすべての入力を再検証
   - エラーがある場合は最初のエラーフィールドにフォーカス

---

## 18. 成功基準

以下の条件がすべて満たされたら実装完了とします:

- [ ] system_adminロールでログインして入札者登録画面にアクセスできる
- [ ] 有効なデータで新規入札者を登録できる
- [ ] UUIDが自動生成される
- [ ] bidder_pointsレコードがバックエンドで作成される
- [ ] 初期ポイント未指定時、bidder_pointsが0で作成される
- [ ] 初期ポイント指定時、bidder_pointsに正しく設定される
- [ ] point_historyレコードがバックエンドで作成される（初期ポイント > 0の場合、type='grant'）
- [ ] point_historyに正しいadmin_idが設定される
- [ ] 初期ポイントが0の場合、point_historyが作成されないこと
- [ ] トランザクションが正しく動作する（全成功または全失敗）
- [ ] 登録成功後、入札者一覧画面にリダイレクトされる
- [ ] 登録した入札者が一覧に表示される
- [ ] ポイント残高が正しく表示される
- [ ] メールアドレス重複時にエラーメッセージが表示される
- [ ] 入力バリデーションが正しく動作する
- [ ] パスワード確認が正しく動作する
- [ ] 初期ポイントのバリデーションが正しく動作する
- [ ] auctioneersロールではアクセスできない（403エラー）
- [ ] 未認証ユーザーはアクセスできない（ログイン画面へリダイレクト）
- [ ] レスポンシブデザインが正しく動作する（スマホ/タブレット/PC）
- [ ] キーボード操作で登録できる
- [ ] すべてのテストが通過する

---

## 19. 次のステップ

この実装完了後、以下の機能を実装予定:

1. **入札者編集画面（1.2.6）**
   - 既存入札者の情報編集
   - パスワード変更
   - アカウント状態変更（停止・復活）
   - 追加ポイント付与
   - 削除（論理削除）

2. **入札者詳細画面（1.2.7）**
   - 入札者の詳細情報表示
   - ポイント残高表示
   - 入札履歴表示
   - ポイント履歴表示

3. **入札者一覧画面（1.2.4）**
   - 入札者の一覧表示
   - 検索・フィルタ機能
   - ソート機能
   - ページネーション

4. **ポイント管理機能（将来実装）**
   - 一括ポイント付与
   - ポイント履歴の詳細表示
   - ポイント統計

---

## 20. 参考資料

### 20.1 関連ドキュメント

- [画面一覧](../screen_list.md): すべての画面の概要
- [データベース定義](../database_definition.md): テーブル構造の詳細
- [アーキテクチャドキュメント](../architecture.md): システム全体の設計
- [管理者登録実装プラン](./admin_registration_implementation_plan.md): 類似機能の参考
- [入札者一覧実装プラン](./bidder_list_implementation_plan.md): 関連機能

### 20.2 技術仕様

- bcrypt: Adaptive Hash Algorithm
- UUID: RFC 4122 Version 4（ランダムUUID）
- REST API: RESTful設計原則
- HTTP Status Codes: RFC 7231

### 20.3 データベーストリガー（廃止予定）

- ~~`trigger_create_bidder_points`~~: **削除予定**（バックエンドで手動作成が必要）
- ~~`trigger_record_point_history`~~: **マイグレーション007で削除済み**（バックエンドで手動作成が必要）

### 20.4 重要な変更履歴

- **マイグレーション007**: point_history自動記録トリガーを削除
  - 理由: アプリケーションが明示的にpoint_historyを作成する際に重複エントリが発生するため
  - 影響: すべてのポイント操作でpoint_historyレコードを手動作成する必要がある

- **トリガー廃止方針**: bidder_points自動作成トリガーも削除予定
  - 理由: アプリケーション層で明示的な制御を行うため
  - 影響: 入札者登録時にbidder_pointsレコードも手動作成する必要がある

---

**作成者**: Claude Code
**レビュー状態**: 未レビュー
**最終更新**: 2025年11月22日
