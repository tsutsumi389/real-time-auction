# オークション開催中画面 - 管理者用（1.3.4）実装プラン

**作成日**: 2025年11月26日
**対象画面**: オークション開催中画面 - 管理者用（Admin Auction Live）
**パス**: `/admin/auctions/:id/live`
**権限**: auctioneer / system_admin
**優先度**: 最高（フェーズ1: リアルタイムオークションのコア機能）

---

## 1. 概要

### 1.1 目的
主催者（auctioneer）およびシステム管理者（system_admin）が、オークションをリアルタイムで進行・管理するための画面です。オークションの開始、価格開示、入札状況の監視、終了処理を一つの画面で完結させます。WebSocket接続によるリアルタイム双方向通信により、入札者の行動をライブで把握しながらオークションを円滑に運営できます。

**重要な設計方針**:
- **主催者主導の価格開示**: 主催者が価格を決定し、段階的に開示する（入札者は自由価格で入札できない）
- **リアルタイム性の確保**: WebSocketによる即座の状態反映
- **商品単位のオークション**: 1つのオークションに複数の商品があり、商品ごとに入札・落札が行われる
- **ポイント管理の可視化**: 入札者のポイント予約・消費状況をリアルタイムで確認

### 1.2 対象ユーザー
- **auctioneer（主催者）**: オークションの進行、価格開示、終了処理
- **system_admin（システム管理者）**: すべての機能にアクセス可能、緊急停止機能

### 1.3 主要機能
1. オークション全体および商品ごとのリアルタイム状態表示
2. 商品情報・メディア表示（画像スライダー、動画再生）
3. 入札履歴のリアルタイム更新表示
4. 価格開示履歴の表示
5. 参加入札者リストのリアルタイム更新
6. 主催者コントロールパネル
   - **商品開始**: 開始価格を公開して入札受付開始
   - **価格開示**: 入札があった場合、次の価格を開示
   - **商品終了**: 入札がない場合、前回の価格で落札者確定。入札がある場合、現在価格で落札者確定
7. システム管理者専用機能
   - 緊急停止（status → cancelled）
   - 全入札者への返金処理

---

## 2. 画面レイアウト

### 2.1 画面構成（デスクトップ）

```
┌───────┬─────────────────────────────────────────────────────────────────────┐
│       │ [ロゴ] オークション進行中                            [ログアウト]    │
│       ├─────────────────────────────────────────────────────────────────────┤
│ サイド│                                                                     │
│ メニュー │ オークション: 2025年春季競走馬セリ                  [状態: active]  │
│       │                                                                     │
│       │ ┌──────────────────────┬────────────────────────────────────────┐   │
│       │ │ 商品情報              │ 主催者コントロール                      │   │
│       │ │                      │                                        │   │
│       │ │ [商品画像スライダー]   │ 現在の商品: #1 ディープインパクト産駒   │   │
│       │ │ ◀ 1/5 ▶             │                                        │   │
│       │ │                      │ 現在価格: ¥1,500,000                   │   │
│       │ │ 商品名: ディープインパク│ 最新入札: 佐藤太郎 (2秒前)              │   │
│       │ │ 開始価格: ¥1,000,000  │                                        │   │
│       │ │                      │ ┌────────────────────────────────────┐ │   │
│       │ │ 説明:                │ │ 次の価格を開示                      │ │   │
│       │ │ 2023年生まれの牡馬...  │ │                                    │ │   │
│       │ │                      │ │ 新しい価格 *                        │ │   │
│       │ │ [詳細を表示]          │ │ [_______________] 円                │ │   │
│       │ │                      │ │                                    │ │   │
│       │ │                      │ │ [価格を開示する]                    │ │   │
│       │ └──────────────────────┤ └────────────────────────────────────┘ │   │
│       │                        │                                        │   │
│       │ 入札履歴 (リアルタイム) │ 参加入札者 (15名)                       │   │
│       │                        │                                        │   │
│       │ ┌──────────────────────┼────────────────────────────────────────┤   │
│       │ │ 佐藤太郎              │ ● 佐藤太郎 (入札: 3回)                  │   │
│       │ │ ¥1,500,000           │ ● 鈴木花子 (入札: 2回)                  │   │
│       │ │ 2秒前                │ ● 田中一郎 (入札: 5回)                  │   │
│       │ │                      │ ○ 山田美咲 (入札: 0回)                  │   │
│       │ │ 鈴木花子              │ ○ 中村誠 (入札: 0回)                    │   │
│       │ │ ¥1,400,000           │ ...                                    │   │
│       │ │ 1分前                │                                        │   │
│       │ │                      │ ● = 入札済み / ○ = 未入札              │   │
│       │ │ ...                  │                                        │   │
│       │ └──────────────────────┴────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 価格開示履歴                                                         │
│       │ ┌─────────────────────────────────────────────────────────────────┐ │
│       │ │ ¥1,500,000 - 開示者: 山田主催者 (30秒前) - 入札あり               │ │
│       │ │ ¥1,400,000 - 開示者: 山田主催者 (2分前) - 入札あり                │ │
│       │ │ ¥1,300,000 - 開示者: 山田主催者 (3分前) - 入札なし                │ │
│       │ └─────────────────────────────────────────────────────────────────┘ │
│       │                                                                     │
│       │ [一覧に戻る]  [商品を終了]  [緊急停止 (system_adminのみ)]           │
│       │                                                                     │
└───────┴─────────────────────────────────────────────────────────────────────┘
```

### 2.2 画面構成（モバイル）

```
┌─────────────────────────────────┐
│ ☰  オークション進行中   [ログアウト] │
├─────────────────────────────────┤
│                                 │
│ 2025年春季競走馬セリ   [active]  │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ [商品画像スライダー]           │ │
│ │ ◀ 1/5 ▶                     │ │
│ └─────────────────────────────┘ │
│                                 │
│ 商品 #1: ディープインパクト産駒   │
│ 現在価格: ¥1,500,000             │
│ 最新入札: 佐藤太郎 (2秒前)       │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 次の価格を開示               │ │
│ │                             │ │
│ │ 新しい価格 *                 │ │
│ │ [_______________] 円         │ │
│ │                             │ │
│ │ [価格を開示する]             │ │
│ └─────────────────────────────┘ │
│                                 │
│ [タブ: 入札履歴 | 参加者 | 履歴] │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ 佐藤太郎                     │ │
│ │ ¥1,500,000 - 2秒前          │ │
│ │                             │ │
│ │ 鈴木花子                     │ │
│ │ ¥1,400,000 - 1分前          │ │
│ │                             │ │
│ │ ...                         │ │
│ └─────────────────────────────┘ │
│                                 │
│ [一覧に戻る]  [商品を終了]       │
│                                 │
└─────────────────────────────────┘
```

### 2.3 デザイン要件

- **レイアウト**:
  - デスクトップ: 3カラム（商品情報、コントロールパネル、入札履歴/参加者リスト）
  - モバイル: 1カラム、タブ切り替え
- **リアルタイム表示**:
  - 新規入札: フェードインアニメーション、ハイライト（3秒間）
  - 価格更新: パルスアニメーション、色変化（青→緑→青）
  - 参加者接続/切断: ステータスアイコン変化（●/○）
- **配色**:
  - アクティブな要素: 青系（primary）
  - 最新入札: 緑系（成功）
  - 警告: 黄色系（warning）
  - 緊急停止: 赤系（destructive）
- **ボタン**:
  - 価格開示ボタン: 大きく目立つ、青系
  - 商品終了ボタン: 灰色系（secondary）
  - 緊急停止ボタン: 赤系、確認モーダル必須
- **画像スライダー**:
  - 矢印ボタン（◀▶）で操作
  - インジケーター（1/5）表示
  - スワイプ対応（モバイル）
- **スクロール**:
  - 入札履歴: 自動スクロール（最新が常に上部）
  - 参加者リスト: 固定高さ、スクロール可能

---

## 3. 入力項目とバリデーション

### 3.1 次の価格開示

#### 3.1.1 新しい価格

| 項目 | 内容 |
|------|------|
| **ラベル** | 新しい価格 * |
| **入力形式** | 数値入力（number type） |
| **プレースホルダー** | 例: 1600000 |
| **必須/任意** | 必須 |
| **単位** | 円（JPY） |

**バリデーションルール:**
1. 空欄の場合: 「価格を入力してください」
2. 0以下の場合: 「価格は1円以上で入力してください」
3. 現在価格以下の場合: 「現在価格（¥1,500,000）より高い価格を入力してください」
4. 10億円を超える場合: 「価格は10億円以内で入力してください」
5. 小数点が含まれる場合: 「整数で入力してください」

**バリデーションタイミング:**
- リアルタイム: フィールドからフォーカスが外れた時（onBlur）
- 送信時: 価格を開示するボタンをクリックした時

---

## 4. 処理フロー

### 4.1 オークション開始フロー（pending → active）

**前提条件:**
- 商品作成時に開始価格（starting_price）が既に設定されている
- オークション開始時はこの開始価格を current_price として公開する

```
[主催者] オークション一覧から「開催中オークションへ」をクリック
    ↓
[システム] オークション詳細画面へ遷移（/admin/auctions/:id/live）
    ↓
[システム] WebSocket接続を確立
    ↓
[フロントエンド] 商品情報を表示
    - 商品名: ディープインパクト産駒
    - 開始価格: ¥1,000,000（starting_priceを表示）
    - 「オークションを開始」ボタンを表示
    ↓
[主催者] 「オークションを開始」ボタンをクリック
    ↓
[フロントエンド] 開始確認モーダルを表示
    - 商品名: ディープインパクト産駒
    - 開始価格: ¥1,000,000
    - 「この価格でオークションを開始しますか?」
    ↓
[主催者] 確認ボタンをクリック
    ↓
[フロントエンド] POST /api/items/:id/start を送信
    ↓
[バックエンド]
    - 商品の状態を確認（started_at が NULL であること）
    - items.current_price に starting_price を設定
    - items.started_at にタイムスタンプを記録
    - auctions.status を 'active' に更新（最初の商品の場合）
    - Redis: `item:{id}:current_price` を設定
    - Redis: `item:{id}:has_bid` を false に設定
    ↓
[バックエンド] WebSocket: `auction:started` イベントを全接続クライアントに配信
    {
      "type": "auction:started",
      "auction_id": "uuid",
      "item_id": "uuid",
      "item_name": "ディープインパクト産駒",
      "current_price": 1000000,
      "started_at": "2025-11-26T10:00:00Z"
    }
    ↓
[フロントエンド] 画面を更新
    - 状態バッジを 'active' に変更
    - 現在価格を表示（¥1,000,000）
    - 「オークションを開始」ボタンを非表示
    - 入札待機状態を表示
    ↓
[成功] オークション開始完了、入札受付開始
```

**エラーハンドリング:**
- 商品が既に開始済み: 「この商品は既に開始されています」
- 開始価格が未設定: 「開始価格が設定されていません。先に商品編集から設定してください」
- 権限不足: 「この操作を実行する権限がありません」

### 4.2 価格開示フロー（入札があった場合の次の価格開示）

**前提条件:**
- オークションが既に開始されている（current_price が設定済み）
- 現在の価格で入札があった（has_bid = true）

```
[入札者] 現在価格で入札を実行（例: ¥1,000,000）
    ↓
[バックエンド] Redis: `item:{id}:has_bid` を true に設定
    ↓
[フロントエンド] 管理者画面に入札通知を表示
    - 「入札あり」バッジを表示
    - 最新入札者: 佐藤太郎
    ↓
[主催者] 入札があったことを確認
    ↓
[主催者] 新しい価格を入力（例: ¥1,100,000）
    ↓
[フロントエンド] リアルタイムバリデーション（現在価格より高いか確認）
    ↓
[主催者] 「価格を開示する」ボタンをクリック
    ↓
[フロントエンド] 確認モーダルを表示
    - 現在価格: ¥1,000,000
    - 新しい価格: ¥1,100,000
    - 値上げ幅: ¥100,000
    - 「この価格で次の入札を受け付けますか?」
    ↓
[主催者] 確認ボタンをクリック
    ↓
[フロントエンド] POST /api/items/:id/open-price を送信
    {
      "new_price": 1100000
    }
    ↓
[バックエンド]
    - 現在の has_bid フラグを確認（入札があることを確認）
    - items.current_price を更新（1,000,000 → 1,100,000）
    - price_history レコードを挿入（開示者、価格、タイムスタンプ、had_bid=true）
    - Redis: `item:{id}:current_price` を更新
    - Redis: `item:{id}:has_bid` を false にリセット
    ↓
[バックエンド] WebSocket: `auction:price_open` イベントを配信
    {
      "type": "auction:price_open",
      "item_id": "uuid",
      "new_price": 1100000,
      "previous_price": 1000000,
      "disclosed_by": "山田主催者",
      "disclosed_at": "2025-11-26T10:05:00Z"
    }
    ↓
[フロントエンド] 管理者画面および入札者画面を更新
    - 現在価格を更新（アニメーション付き）
    - 価格開示履歴に新規エントリ追加（「入札あり」バッジ付き）
    - 入力フォームをリセット
    - 「入札あり」バッジを非表示
    ↓
[成功] 価格開示完了、次の入札受付開始
```

**エラーハンドリング:**
- 新しい価格が現在価格以下: 「現在価格より高い価格を入力してください」
- 商品が終了済み: 「この商品は既に終了しています」
- 同時実行エラー: 「他の主催者が価格を更新しました。画面を更新してください」

### 4.3 入札受信フロー（入札者からの入札をリアルタイム表示）

```
[入札者] 入札ボタンをクリック（入札者用画面）
    ↓
[入札者フロントエンド] WebSocket: `auction:bid` イベントを送信
    {
      "type": "auction:bid",
      "item_id": "uuid",
      "price": 1600000
    }
    ↓
[WebSocketサーバー]
    - JWT認証チェック
    - 入札者ロール確認
    - 価格が現在価格と一致するか確認
    ↓
[バックエンドサービス]
    - 入札者のポイント残高確認（available_points >= price）
    - Redis: distributed lock 取得（同時入札制御）
    ↓
[バックエンド] トランザクション開始
    - bids テーブルに新規レコード挿入
    - bidder_points 更新（available_points - price, reserved_points + price）
    - point_history に記録（種別: 'reserve'）
    - 既存の is_winning フラグを false に更新
    - 新規入札の is_winning を true に設定
    ↓
[バックエンド] トランザクションコミット
    ↓
[バックエンド] Redis
    - `item:{id}:has_bid` を true に設定
    - `item:{id}:last_bidder` を入札者情報に更新
    - Pub/Sub: `auction:bid` チャネルに配信（全WebSocketサーバーへ）
    ↓
[WebSocketサーバー] 全接続クライアントに `auction:bid` イベントを配信
    {
      "type": "auction:bid",
      "item_id": "uuid",
      "bidder_name": "佐藤太郎",
      "price": 1600000,
      "bid_at": "2025-11-26T10:06:00Z",
      "total_bids": 15
    }
    ↓
[管理者フロントエンド]
    - 入札履歴リストの最上部に新規エントリ追加（アニメーション）
    - 最新入札者情報を更新
    - 参加入札者リストの該当入札者の入札回数を +1
    - 「入札あり」バッジを表示
    ↓
[成功] 入札受信完了
```

### 4.4 商品終了フロー（入札がない場合）

**前提条件:**
- オークションが開始されている
- 現在の価格で入札がない（has_bid = false）
- 主催者が終了を決定

```
[主催者] 現在価格で入札がないことを確認
    ↓
[主催者] 「オークションを終了」ボタンをクリック
    ↓
[フロントエンド] 終了確認モーダルを表示
    - 現在の商品: #1 ディープインパクト産駒
    - 現在価格: ¥1,200,000（入札なし）
    - 前回の価格: ¥1,100,000
    - 落札者: 佐藤太郎（前回価格での入札者）
    - 「前回の価格（¥1,100,000）で落札者を確定しますか?」
    ↓
[主催者] 確認ボタンをクリック
    ↓
[フロントエンド] POST /api/items/:id/end を送信
    ↓
[バックエンド]
    - has_bid フラグを確認（false = 現在価格で入札なし）
    - 最後の is_winning = true の入札者を取得（前回価格での入札者）
    - items.winner_id に設定
    - items.ended_at にタイムスタンプ記録
    - 落札価格は前回の価格（current_price ではなく、最後の入札価格）
    ↓
[バックエンド] ポイント確定処理
    - 落札者: bidder_points 更新（reserved_points - price）
    - 落札者: point_history に記録（種別: 'consume'）
    - 非落札者: 予約ポイント解放（reserved → available）
    - 非落札者: point_history に記録（種別: 'release'）
    ↓
[バックエンド] WebSocket: `auction:ended` イベントを配信
    {
      "type": "auction:ended",
      "item_id": "uuid",
      "winner_id": "uuid",
      "winner_name": "佐藤太郎",
      "final_price": 1100000,
      "ended_at": "2025-11-26T10:10:00Z"
    }
    ↓
[フロントエンド]
    - 落札者発表モーダルを表示
    - 「入札がなかったため、前回の価格で落札が確定しました」メッセージ表示
    - 価格開示パネルを非表示
    - 状態バッジを 'ended' に変更
    - 「次の商品へ」ボタンを表示（複数商品の場合）
    ↓
[成功] 商品終了完了、落札者確定
```

### 4.5 商品終了フロー（入札がある場合）

**前提条件:**
- 現在の価格で入札がある（has_bid = true）
- 主催者がこれ以上の価格開示をせずに終了を決定

```
[主催者] 現在価格で入札があることを確認
    ↓
[主催者] 「オークションを終了」ボタンをクリック
    ↓
[フロントエンド] 終了確認モーダルを表示
    - 現在の商品: #1 ディープインパクト産駒
    - 最終価格: ¥1,600,000（入札あり）
    - 落札者: 佐藤太郎
    - 「この価格で落札者を確定しますか?」
    ↓
[主催者] 確認ボタンをクリック
    ↓
[フロントエンド] POST /api/items/:id/end を送信
    ↓
[バックエンド]
    - has_bid フラグを確認（true = 現在価格で入札あり）
    - 最後の is_winning = true の入札者を取得
    - items.winner_id に設定
    - items.ended_at にタイムスタンプ記録
    - 落札価格は current_price
    ↓
[バックエンド] ポイント確定処理
    - 落札者: bidder_points 更新（reserved_points - price）
    - 落札者: point_history に記録（種別: 'consume'）
    - 非落札者: 予約ポイント解放（reserved → available）
    - 非落札者: point_history に記録（種別: 'release'）
    ↓
[バックエンド] WebSocket: `auction:ended` イベントを配信
    {
      "type": "auction:ended",
      "item_id": "uuid",
      "winner_id": "uuid",
      "winner_name": "佐藤太郎",
      "final_price": 1600000,
      "ended_at": "2025-11-26T10:10:00Z"
    }
    ↓
[フロントエンド]
    - 落札者発表モーダルを表示
    - 価格開示パネルを非表示
    - 状態バッジを 'ended' に変更
    - 「次の商品へ」ボタンを表示（複数商品の場合）
    ↓
[成功] 商品終了完了、落札者確定
```

**複数商品がある場合:**
- 「次の商品へ」ボタンをクリック → 次の商品の表示に切り替え
- 全商品が終了 → オークション全体を 'ended' に更新

**エラーハンドリング:**
- 入札が1件もない場合: 「入札がないため終了できません。オークションをキャンセルしてください」

### 4.6 緊急停止フロー（system_adminのみ）

```
[システム管理者] 「緊急停止」ボタンをクリック
    ↓
[フロントエンド] 緊急停止確認モーダルを表示
    - 警告: 「この操作は取り消せません」
    - 「すべての入札を無効化し、ポイントを返金します」
    - 理由入力フィールド（任意）
    ↓
[システム管理者] 確認ボタンをクリック
    ↓
[フロントエンド] POST /api/auctions/:id/cancel を送信
    {
      "reason": "システムエラーのため緊急停止"
    }
    ↓
[バックエンド] トランザクション開始
    - auctions.status を 'cancelled' に更新
    - すべての items.ended_at を現在時刻に設定
    - すべての入札者の reserved_points を available_points に戻す
    - point_history に返金記録（種別: 'refund'）
    ↓
[バックエンド] トランザクションコミット
    ↓
[バックエンド] WebSocket: `auction:cancelled` イベントを配信
    {
      "type": "auction:cancelled",
      "auction_id": "uuid",
      "reason": "システムエラーのため緊急停止",
      "cancelled_at": "2025-11-26T10:15:00Z"
    }
    ↓
[フロントエンド]
    - 緊急停止通知を表示
    - すべてのコントロールを無効化
    - 状態バッジを 'cancelled' に変更
    - 「オークション一覧に戻る」ボタンを表示
    ↓
[成功] 緊急停止完了
```

---

## 5. セキュリティ要件

### 5.1 認証・認可
- **JWT認証**: すべてのAPIリクエストおよびWebSocket接続で必須
- **ロールチェック**: auctioneer または system_admin のみアクセス可能
- **オークション所有権**: 主催者は自分が作成したオークションのみ操作可能（system_adminは全て操作可能）
- **緊急停止権限**: system_adminのみ実行可能

### 5.2 データ保護
- **価格データ**: バックエンドで厳密にバリデーション（現在価格より高いか確認）
- **同時実行制御**: Redis distributed lock で複数主催者の同時価格開示を防止
- **トランザクション**: ポイント操作は必ずDBトランザクション内で実行
- **監査ログ**: すべての価格開示、入札、終了操作を price_history および bids テーブルに記録

### 5.3 WebSocketセキュリティ
- **接続時認証**: JWT tokenをクエリパラメータまたはヘッダーで送信
- **メッセージ検証**: 受信メッセージの形式、型、値を厳密にチェック
- **レート制限**: 1秒間に10リクエストまで（異常な頻度の操作を防止）
- **自動切断**: 無効なトークン、不正なメッセージで即座に切断

### 5.4 一般的な脆弱性対策
- **XSS対策**: ユーザー入力（商品名、説明）のエスケープ処理
- **CSRF対策**: Ginのミドルウェアで実装済み
- **SQLインジェクション**: GORM使用により自動防止
- **認可チェック**: すべてのエンドポイントで実行

---

## 6. データベース設計

### 6.1 関連テーブル

#### auctions テーブル（オークション全体）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | オークションID |
| title | VARCHAR(200) | NOT NULL | オークションタイトル |
| description | TEXT | - | オークション説明 |
| status | VARCHAR(20) | NOT NULL | 状態（pending/active/ended/cancelled） |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | 更新日時 |

#### items テーブル（商品）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 商品ID |
| auction_id | UUID | FOREIGN KEY | オークションID |
| name | VARCHAR(200) | NOT NULL | 商品名 |
| description | TEXT | - | 商品説明 |
| starting_price | BIGINT | - | 開始価格 |
| current_price | BIGINT | - | 現在価格 |
| winner_id | UUID | FOREIGN KEY | 落札者ID |
| started_at | TIMESTAMPTZ | - | 開始日時 |
| ended_at | TIMESTAMPTZ | - | 終了日時 |
| display_order | INTEGER | NOT NULL | 表示順序 |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | 更新日時 |

**制約:**
- `CHECK (starting_price IS NULL OR starting_price > 0)`
- `CHECK (ended_at IS NULL OR started_at IS NULL OR ended_at >= started_at)`

#### bids テーブル（入札）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 入札ID |
| item_id | UUID | FOREIGN KEY | 商品ID |
| bidder_id | UUID | FOREIGN KEY | 入札者ID |
| price | BIGINT | NOT NULL | 入札価格 |
| is_winning | BOOLEAN | DEFAULT FALSE | 現在の勝者か |
| bid_at | TIMESTAMPTZ | NOT NULL | 入札日時 |

**制約:**
- `CHECK (price > 0)`

**インデックス:**
- `idx_bids_item ON bids(item_id, bid_at DESC)` - 入札履歴取得用
- `idx_bids_winning ON bids(item_id, is_winning) WHERE is_winning = TRUE` - 勝者検索用

#### price_history テーブル（価格開示履歴）

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 履歴ID |
| item_id | UUID | FOREIGN KEY | 商品ID |
| price | BIGINT | NOT NULL | 開示価格 |
| disclosed_by | UUID | FOREIGN KEY | 開示者ID（admin） |
| had_bid | BOOLEAN | DEFAULT FALSE | この価格で入札があったか |
| disclosed_at | TIMESTAMPTZ | NOT NULL | 開示日時 |

### 6.2 テストデータ仕様

開発・テスト用にサンプルデータを作成します（migration 004で挿入済み）。

**オークションデータ:**
- タイトル: 「2025年春季競走馬セリ」
- 状態: 'pending'
- 商品数: 3件

**商品データ:**
- 商品1: 「ディープインパクト産駒」、開始価格: ¥1,000,000
- 商品2: 「キングカメハメハ産駒」、開始価格: ¥800,000
- 商品3: 「ロードカナロア産駒」、開始価格: ¥1,200,000

**入札者データ:**
- 入札者10名、各自ポイント: 5,000,000

---

## 7. API仕様

### 7.1 商品開始

**エンドポイント:** `POST /api/items/:id/start`
**認証:** 必須（auctioneer / system_admin）
**説明:** 商品のオークションを開始し、開始価格を現在価格として公開

**リクエスト:**
```json
{}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "data": {
    "item_id": "uuid",
    "auction_id": "uuid",
    "current_price": 1000000,
    "started_at": "2025-11-26T10:00:00Z"
  }
}
```

**レスポンス（エラー）:**
```json
{
  "success": false,
  "error": {
    "code": "ALREADY_STARTED",
    "message": "この商品は既に開始されています"
  }
}
```

### 7.2 価格開示

**エンドポイント:** `POST /api/items/:id/open-price`
**認証:** 必須（auctioneer / system_admin）
**説明:** 新しい価格を開示

**リクエスト:**
```json
{
  "new_price": 1600000
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "data": {
    "item_id": "uuid",
    "current_price": 1600000,
    "previous_price": 1500000,
    "disclosed_at": "2025-11-26T10:05:00Z"
  }
}
```

**レスポンス（エラー - 価格が低い）:**
```json
{
  "success": false,
  "error": {
    "code": "PRICE_TOO_LOW",
    "message": "新しい価格は現在価格（¥1,500,000）より高く設定してください"
  }
}
```

### 7.3 商品終了

**エンドポイント:** `POST /api/items/:id/end`
**認証:** 必須（auctioneer / system_admin）
**説明:** 商品のオークションを終了し、落札者を確定

**リクエスト:**
```json
{}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "data": {
    "item_id": "uuid",
    "winner_id": "uuid",
    "winner_name": "佐藤太郎",
    "final_price": 1600000,
    "ended_at": "2025-11-26T10:10:00Z"
  }
}
```

**レスポンス（エラー - 入札なし）:**
```json
{
  "success": false,
  "error": {
    "code": "NO_BIDS",
    "message": "この商品には入札がありません"
  }
}
```

### 7.4 緊急停止

**エンドポイント:** `POST /api/auctions/:id/cancel`
**認証:** 必須（system_adminのみ）
**説明:** オークションを緊急停止し、全ポイントを返金

**リクエスト:**
```json
{
  "reason": "システムエラーのため緊急停止"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "data": {
    "auction_id": "uuid",
    "status": "cancelled",
    "refunded_bidders": 15,
    "total_refunded_points": 24000000,
    "cancelled_at": "2025-11-26T10:15:00Z"
  }
}
```

### 7.5 オークション詳細取得

**エンドポイント:** `GET /api/auctions/:id`
**認証:** 必須
**説明:** オークション全体の情報を取得（商品リスト含む）

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "title": "2025年春季競走馬セリ",
    "description": "...",
    "status": "active",
    "created_at": "2025-11-20T09:00:00Z",
    "items": [
      {
        "id": "uuid",
        "name": "ディープインパクト産駒",
        "description": "...",
        "starting_price": 1000000,
        "current_price": 1600000,
        "winner_id": null,
        "started_at": "2025-11-26T10:00:00Z",
        "ended_at": null,
        "display_order": 1,
        "media": [
          {
            "id": "uuid",
            "url": "/media/items/uuid/image1.jpg",
            "media_type": "image",
            "display_order": 1
          }
        ]
      }
    ]
  }
}
```

### 7.6 入札履歴取得

**エンドポイント:** `GET /api/items/:id/bids`
**認証:** 必須
**説明:** 商品の入札履歴を取得（最新順）

**クエリパラメータ:**
- `limit`: 取得件数（デフォルト: 50、最大: 200）
- `offset`: オフセット（ページネーション用）

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "total": 15,
    "bids": [
      {
        "id": "uuid",
        "bidder_id": "uuid",
        "bidder_name": "佐藤太郎",
        "price": 1600000,
        "is_winning": true,
        "bid_at": "2025-11-26T10:06:00Z"
      },
      {
        "id": "uuid",
        "bidder_id": "uuid",
        "bidder_name": "鈴木花子",
        "price": 1500000,
        "is_winning": false,
        "bid_at": "2025-11-26T10:05:30Z"
      }
    ]
  }
}
```

### 7.7 参加入札者リスト取得

**エンドポイント:** `GET /api/auctions/:id/participants`
**認証:** 必須（auctioneer / system_admin）
**説明:** オークションに参加中の入札者リストを取得

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "total": 15,
    "participants": [
      {
        "bidder_id": "uuid",
        "display_name": "佐藤太郎",
        "bid_count": 3,
        "is_online": true,
        "last_bid_at": "2025-11-26T10:06:00Z"
      },
      {
        "bidder_id": "uuid",
        "display_name": "鈴木花子",
        "bid_count": 2,
        "is_online": true,
        "last_bid_at": "2025-11-26T10:05:30Z"
      }
    ]
  }
}
```

### 7.8 価格開示履歴取得

**エンドポイント:** `GET /api/items/:id/price-history`
**認証:** 必須
**説明:** 商品の価格開示履歴を取得

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "total": 5,
    "history": [
      {
        "id": "uuid",
        "price": 1600000,
        "disclosed_by_name": "山田主催者",
        "had_bid": true,
        "disclosed_at": "2025-11-26T10:05:00Z"
      },
      {
        "id": "uuid",
        "price": 1500000,
        "disclosed_by_name": "山田主催者",
        "had_bid": true,
        "disclosed_at": "2025-11-26T10:03:00Z"
      }
    ]
  }
}
```

---

## 8. バックエンド実装要件

### 8.1 レイヤー別責務

#### Domain層（内部/domain/）
**役割:** データ構造（Go構造体）の定義

**必要な構造体:**
- `Auction`: オークション全体の情報
- `Item`: 商品情報
- `Bid`: 入札情報
- `PriceHistory`: 価格開示履歴
- `Admin`: 管理者情報
- `Bidder`: 入札者情報

**サンプル構造（Itemの例）:**
```
- ID（UUID）
- AuctionID（UUID）
- Name（商品名）
- Description（説明）
- StartingPrice（開始価格）
- CurrentPrice（現在価格）
- WinnerID（落札者ID、NULL可能）
- StartedAt（開始日時、NULL可能）
- EndedAt（終了日時、NULL可能）
- DisplayOrder（表示順序）
- CreatedAt（作成日時）
- UpdatedAt（更新日時）
```

#### Repository層（internal/repository/）
**役割:** データベースおよびRedisへのアクセス

**必要な機能:**
- オークション取得・更新
- 商品取得・更新・開始・終了
- 入札履歴取得・挿入
- 価格開示履歴取得・挿入
- 参加者リスト取得
- Redisからの状態取得・更新（current_price, has_bid, last_bidder）

**技術:**
- GORM（PostgreSQL ORM）
- go-redis（Redisクライアント）

#### Service層（internal/service/）
**役割:** ビジネスロジックの実装

**主要な機能:**
- 商品開始ロジック
  - 状態検証（started_at が NULL であること）
  - 開始価格（starting_price）を現在価格（current_price）に設定
  - タイムスタンプ記録（started_at）
  - Redis初期化（current_price, has_bid=false）
- 価格開示ロジック
  - バリデーション（新価格 > 現在価格）
  - has_bid フラグ確認（入札があることを確認）
  - 価格更新とRedis同期
  - price_history レコード挿入
- 商品終了ロジック
  - has_bid フラグ確認
  - 入札がない場合: 前回の価格で落札者確定
  - 入札がある場合: 現在価格で落札者確定
  - 落札者特定（is_winning = true の入札者）
  - ポイント確定（落札者: reserved → 消費、非落札者: reserved → available）
  - 監査ログ記録
- 緊急停止ロジック
  - 全商品の強制終了
  - 全入札者への返金処理
  - トランザクション管理

**注意点:**
- すべてのポイント操作はDBトランザクション内で実行
- Redisとの整合性を保つ（price更新時はRedisも同時更新）

#### Handler層（internal/handler/）
**役割:** HTTPリクエストの受付とレスポンス返却

**必要なハンドラー:**
- `StartItem`: POST /api/items/:id/start
- `OpenPrice`: POST /api/items/:id/open-price
- `EndItem`: POST /api/items/:id/end
- `CancelAuction`: POST /api/auctions/:id/cancel（system_adminのみ）
- `GetAuction`: GET /api/auctions/:id
- `GetBids`: GET /api/items/:id/bids
- `GetParticipants`: GET /api/auctions/:id/participants
- `GetPriceHistory`: GET /api/items/:id/price-history

**共通処理:**
- JWT認証ミドルウェア
- ロールチェックミドルウェア（auctioneer/system_admin）
- エラーハンドリング（統一フォーマット）
- バリデーション（リクエストボディ）

#### WebSocket層（internal/ws/）
**役割:** WebSocket接続管理、イベント配信

**必要なコンポーネント:**
- Hub: クライアント管理、ブロードキャスト
- Client: 個別のWebSocket接続
- EventHandler: WebSocketメッセージの処理

**イベント定義:**
- `auction:started`: オークション開始
- `auction:price_open`: 価格開示
- `auction:bid`: 入札発生
- `auction:ended`: 商品終了
- `auction:cancelled`: 緊急停止

**処理フロー:**
1. クライアントが `/ws` エンドポイントに接続
2. JWT認証（クエリパラメータまたはヘッダー）
3. Hubに登録、オークションルームに参加
4. サービス層からRedis Pub/Subでイベント受信
5. Hubが該当ルームの全クライアントにブロードキャスト

#### Middleware層（internal/middleware/）
**役割:** 共通処理の実装

**必要なミドルウェア:**
- JWT認証ミドルウェア
- ロールチェックミドルウェア（RequireRole("auctioneer", "system_admin")）
- CORS設定
- ログ記録

### 8.2 技術スタック

- **Go**: 1.23
- **Gin**: HTTPルーター
- **GORM**: PostgreSQL ORM
- **go-redis**: Redisクライアント
- **Gorilla WebSocket**: WebSocketライブラリ
- **golang-jwt/jwt**: JWT認証
- **Air**: ホットリロード

---

## 9. フロントエンド実装要件

### 9.1 ディレクトリ構造

```
frontend/src/
  views/
    admin/
      auctions/
        AuctionLive.vue          # メイン画面
  components/
    admin/
      auction/
        ItemInfo.vue             # 商品情報表示
        ControlPanel.vue         # 主催者コントロールパネル
        BidHistory.vue           # 入札履歴リスト
        ParticipantList.vue      # 参加者リスト
        PriceHistoryList.vue     # 価格開示履歴
        ImageSlider.vue          # 画像スライダー
  stores/
    auctionStore.js              # オークション状態管理
  services/
    auctionApi.js                # オークションAPI呼び出し
    websocketService.js          # WebSocket接続管理
```

### 9.2 コンポーネント説明

#### AuctionLive.vue（メイン画面）
**役割:** 画面全体のレイアウトと各コンポーネントの配置

**主要な機能:**
- ページ読み込み時にオークション情報取得
- WebSocket接続確立
- 各子コンポーネントへのデータ配信
- 画面アンマウント時のWebSocket切断

**使用する子コンポーネント:**
- ItemInfo
- ControlPanel
- BidHistory
- ParticipantList
- PriceHistoryList

#### ItemInfo.vue（商品情報表示）
**役割:** 商品の詳細情報とメディアを表示

**表示項目:**
- 商品名
- 開始価格
- 現在価格
- 説明
- 画像スライダー（ImageSlider.vue）

#### ControlPanel.vue（主催者コントロールパネル）
**役割:** オークション開始、価格開示、商品終了などの操作

**主要な機能:**
- **オークション開始ボタン**: 商品が未開始の場合に表示（確認モーダル付き）
- **新しい価格入力フォーム**: 入札があった場合のみ表示
- **バリデーション**: 現在価格より高いか
- **価格開示ボタン**: 入札があった場合に有効化（確認モーダル付き）
- **商品終了ボタン**:
  - 入札がない場合: 「前回の価格で落札者確定」メッセージ付き確認モーダル
  - 入札がある場合: 「現在価格で落札者確定」メッセージ付き確認モーダル
- **緊急停止ボタン**: system_adminのみ表示（確認モーダル付き）

#### BidHistory.vue（入札履歴リスト）
**役割:** 入札履歴のリアルタイム表示

**主要な機能:**
- 最新の入札が上部に表示（降順）
- 新規入札時のアニメーション（フェードイン、ハイライト）
- 自動スクロール（最新が常に見える）
- 最大表示件数（デフォルト: 50件）

#### ParticipantList.vue（参加者リスト）
**役割:** 接続中の入札者をリスト表示

**表示項目:**
- 入札者名
- 入札回数
- オンライン状態（●/○）
- 最後の入札時刻

**ソート:** 入札回数降順

#### PriceHistoryList.vue（価格開示履歴）
**役割:** 過去の価格開示履歴を表示

**表示項目:**
- 開示価格
- 開示者名
- 開示時刻
- 入札有無（「入札あり」/「入札なし」バッジ）

#### ImageSlider.vue（画像スライダー）
**役割:** 商品の画像・動画をスライド表示

**主要な機能:**
- 矢印ボタン（◀▶）で画像切り替え
- インジケーター（1/5）表示
- スワイプ対応（モバイル）
- 動画再生機能

### 9.3 状態管理（Pinia Store）

#### auctionStore.js

**管理する状態:**
- `auction`: オークション全体の情報
- `currentItem`: 現在表示中の商品
- `bids`: 入札履歴（配列）
- `participants`: 参加者リスト（配列）
- `priceHistory`: 価格開示履歴（配列）
- `wsConnected`: WebSocket接続状態

**アクション:**
- `fetchAuction(auctionId)`: オークション情報取得
- `connectWebSocket(auctionId)`: WebSocket接続
- `disconnectWebSocket()`: WebSocket切断
- `startItem(itemId)`: 商品開始（開始価格を公開）
- `openPrice(itemId, newPrice)`: 価格開示
- `endItem(itemId)`: 商品終了
- `cancelAuction(reason)`: 緊急停止
- `handleStartedEvent(data)`: オークション開始イベント受信時の処理
- `handleBidEvent(data)`: WebSocketイベント受信時の処理
- `handlePriceOpenEvent(data)`: 価格開示イベント受信時の処理
- `handleEndedEvent(data)`: 終了イベント受信時の処理

**Getters:**
- `latestBid`: 最新の入札
- `totalBids`: 総入札数
- `onlineParticipants`: オンライン中の参加者数

### 9.4 WebSocket管理（websocketService.js）

**主要な機能:**
- WebSocket接続の確立
- JWT認証（接続時にtokenを送信）
- イベント送信（`auction:join`, `auction:leave`）
- イベント受信（`auction:started`, `auction:price_open`, `auction:bid`, `auction:ended`, `auction:cancelled`）
- 自動再接続（接続切断時）
- エラーハンドリング

**使用例:**
```javascript
// 接続
websocketService.connect(auctionId, token)

// イベント受信
websocketService.on('auction:bid', (data) => {
  // 入札履歴を更新
})

// 切断
websocketService.disconnect()
```

---

## 10. 画面遷移

### 10.1 遷移フロー

```
オークション一覧（/admin/auctions）
    │
    ├─ 「開催中オークションへ」ボタン
    │
    ↓
オークション開催中（/admin/auctions/:id/live）
    │
    ├─ 「オークション一覧に戻る」ボタン
    │   ↓
    │   オークション一覧
    │
    ├─ オークション終了後
    │   ↓
    │   自動的にオークション一覧へリダイレクト（5秒後）
    │
    └─ 緊急停止後
        ↓
        「オークション一覧に戻る」ボタン表示
```

### 10.2 ナビゲーションガード

**認証チェック:**
- ログインしていない → `/admin/login` へリダイレクト

**ロールチェック:**
- auctioneer または system_admin でない → `/admin/dashboard` へリダイレクト

**オークション存在チェック:**
- オークションIDが存在しない → 404エラーページ

**WebSocket接続失敗時:**
- エラー通知を表示
- 「再接続」ボタンを表示

---

## 11. UIの動作仕様

### 11.1 ユーザーインタラクション

#### 価格開示操作
1. 主催者が新しい価格を入力
2. フィールドからフォーカスが外れた時点でバリデーション
3. エラーがあれば赤いテキストで表示
4. 「価格を開示する」ボタンをクリック
5. 確認モーダルが表示される
   - 新しい価格: ¥1,600,000
   - 現在価格: ¥1,500,000
   - 値上げ幅: ¥100,000
6. 「確認」ボタンをクリック → API送信
7. 成功 → モーダルを閉じる、画面を更新
8. エラー → エラーメッセージを表示

#### 商品終了操作
1. 主催者が「商品を終了」ボタンをクリック
2. 確認モーダルが表示される
   - 現在の商品: #1 ディープインパクト産駒
   - 最終価格: ¥1,600,000
   - 落札者: 佐藤太郎
   - 「この商品のオークションを終了しますか?」
3. 「確認」ボタンをクリック → API送信
4. 成功 → 落札者発表モーダルを表示
5. 複数商品がある場合 → 「次の商品へ」ボタンを表示
6. 全商品が終了 → 「オークション一覧に戻る」ボタンを表示

#### 緊急停止操作（system_adminのみ）
1. システム管理者が「緊急停止」ボタンをクリック
2. 警告モーダルが表示される
   - 「この操作は取り消せません」
   - 「すべての入札を無効化し、ポイントを返金します」
   - 理由入力フィールド（任意）
3. 「確認」ボタンをクリック → API送信
4. 成功 → 緊急停止通知を表示、すべてのコントロールを無効化
5. 「オークション一覧に戻る」ボタンを表示

### 11.2 ローディング状態

**初期ロード:**
- オークション情報取得中: スケルトンスクリーン表示
- WebSocket接続中: 「接続中...」インジケーター

**操作中:**
- 価格開示中: ボタンをローディング状態に変更（スピナー表示）
- 商品終了中: ボタンをローディング状態に変更
- 緊急停止中: ボタンをローディング状態に変更

### 11.3 成功・エラーフィードバック

**成功:**
- 価格開示成功: 緑色の通知「価格を¥1,600,000に開示しました」（3秒間表示）
- 商品終了成功: 落札者発表モーダル表示
- 緊急停止成功: 赤色の通知「オークションを緊急停止しました」

**エラー:**
- APIエラー: 赤色の通知、エラーメッセージ表示（10秒間表示）
- WebSocket切断: 黄色の警告「接続が切断されました。再接続中...」
- バリデーションエラー: フィールド下部に赤いテキスト表示

---

## 12. レスポンシブデザイン

### 12.1 ブレークポイント

- **スマートフォン**: 0px - 767px
- **タブレット**: 768px - 1279px
- **デスクトップ**: 1280px以上

### 12.2 デバイス別レイアウト調整

#### スマートフォン（0px - 767px）
- **レイアウト**: 1カラム、タブ切り替え
- **商品情報**: 全幅表示
- **コントロールパネル**: 下部固定
- **入札履歴/参加者/履歴**: タブで切り替え
- **ボタン**: 全幅、大きめサイズ（タップしやすく）
- **画像スライダー**: スワイプ対応

#### タブレット（768px - 1279px）
- **レイアウト**: 2カラム（商品情報 + コントロール/履歴）
- **サイドメニュー**: ハンバーガーメニュー
- **ボタン**: 通常サイズ

#### デスクトップ（1280px以上）
- **レイアウト**: 3カラム（商品情報、コントロールパネル、履歴）
- **サイドメニュー**: 常時表示
- **ボタン**: 通常サイズ

---

## 13. アクセシビリティ

### 13.1 キーボード操作

- **Tab**: フォーカス移動（入力フィールド → ボタン → リンク）
- **Enter**: ボタン実行、モーダル確認
- **Esc**: モーダルを閉じる
- **矢印キー**: 画像スライダー操作（◀▶）

### 13.2 スクリーンリーダー対応

- **aria-label**: すべてのボタン、リンクに意味のあるラベル
- **aria-live**: 入札履歴リスト（新規入札を読み上げ）
- **role**: 適切なロール属性（button, alert, dialog）
- **フォーカス管理**: モーダル表示時、最初の要素にフォーカス

### 13.3 フォーカス管理

- **モーダル表示時**: 最初の入力フィールドにフォーカス
- **モーダル閉じる時**: 元のトリガーボタンにフォーカス復帰
- **タブ順序**: 論理的な順序（上から下、左から右）

---

## 14. テスト要件

### 14.1 テストシナリオ（機能テスト）

#### シナリオ1: 商品開始
1. 主催者としてログイン
2. オークション一覧から pending 状態のオークションを選択
3. オークション詳細画面へ遷移
4. 「オークションを開始」ボタンをクリック
5. 確認モーダルで開始価格を確認
6. **期待結果**: 商品状態が 'active' に変更、現在価格が開始価格に設定、入札受付開始

#### シナリオ2: 入札後の価格開示
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. 入札があったことを確認（「入札あり」バッジ表示）
4. 新しい価格を入力（現在価格より高い）
5. 「価格を開示する」ボタンをクリック
6. 確認モーダルで確認
7. **期待結果**: 現在価格が更新、価格開示履歴に新規エントリ追加、「入札あり」バッジ消失

#### シナリオ3: 入札受信（リアルタイム）
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. 別のブラウザで入札者としてログイン
4. 入札者が入札を実行
5. **期待結果**: 主催者画面の入札履歴にリアルタイムで新規エントリ表示、アニメーション再生

#### シナリオ4: 商品終了（入札がない場合）
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. 価格を開示したが、入札がない状態を確認
4. 「オークションを終了」ボタンをクリック
5. 確認モーダルで「前回の価格で落札者を確定しますか?」を確認
6. **期待結果**: 商品状態が 'ended' に変更、前回価格での落札者が確定、ポイントが消費

#### シナリオ5: 商品終了（入札がある場合）
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. 現在価格で入札があることを確認（「入札あり」バッジ表示）
4. 「オークションを終了」ボタンをクリック
5. 確認モーダルで「現在価格で落札者を確定しますか?」を確認
6. **期待結果**: 商品状態が 'ended' に変更、現在価格での落札者が確定、ポイントが消費

#### シナリオ6: 緊急停止（system_adminのみ）
1. system_adminとしてログイン
2. 開催中のオークションへアクセス
3. 「緊急停止」ボタンをクリック
4. 警告モーダルで理由を入力、確認
5. **期待結果**: オークション状態が 'cancelled' に変更、全入札者の予約ポイントが解放

#### シナリオ7: バリデーションエラー
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. 新しい価格を現在価格以下で入力
4. 「価格を開示する」ボタンをクリック
5. **期待結果**: エラーメッセージ表示「現在価格より高い価格を入力してください」

#### シナリオ8: WebSocket切断・再接続
1. 主催者としてログイン
2. 開催中のオークションへアクセス
3. ブラウザのネットワークを切断
4. **期待結果**: 警告表示「接続が切断されました。再接続中...」
5. ネットワークを再接続
6. **期待結果**: 自動再接続、画面が最新状態に更新

### 14.2 成功基準

- [ ] 商品の開始が正常に動作（開始価格が現在価格として公開される）
- [ ] 入札がある場合の価格開示がリアルタイムで反映
- [ ] 入札がない場合の終了処理が正常に動作（前回価格で落札者確定）
- [ ] 入札がある場合の終了処理が正常に動作（現在価格で落札者確定）
- [ ] 入札履歴がリアルタイムで更新
- [ ] 参加者リストが正確に表示
- [ ] バリデーションエラーが適切に表示
- [ ] WebSocket切断時の再接続が動作
- [ ] レスポンシブデザインが全デバイスで正常
- [ ] アクセシビリティ要件を満たす
- [ ] ロール別のアクセス制御が機能

### 14.3 エッジケース

- 同時に複数の主催者が価格を開示しようとした場合 → 後から送信された方がエラー
- 入札がない状態で終了ボタンを押下した場合 → 前回の価格で落札者確定
- 入札が1件もない状態で終了しようとした場合 → エラー「入札がないため終了できません」
- 開始価格が未設定の商品を開始しようとした場合 → エラー
- WebSocket接続が確立していない状態で画面表示 → 警告表示、手動再接続ボタン

---

## 15. 環境変数

### 15.1 フロントエンド（.env）

```
VITE_API_BASE_URL=http://localhost/api
VITE_WS_URL=ws://localhost/ws
```

### 15.2 バックエンド（.env）

```
DB_HOST=postgres
DB_PORT=5432
DB_USER=auction_user
DB_PASSWORD=auction_password
DB_NAME=auction_db

REDIS_HOST=redis
REDIS_PORT=6379

JWT_SECRET=your-secret-key-here
JWT_EXPIRATION=24h

CORS_ORIGINS=http://localhost

WS_PORT=8081
API_PORT=8080
```

---

## 16. 実装手順

### 16.1 フェーズ1: バックエンド基礎（推定: 5日）

- [ ] Domain層: 構造体定義（Auction, Item, Bid, PriceHistory）
- [ ] Repository層: データベースアクセス実装
- [ ] Service層: ビジネスロジック実装
  - [ ] オークション開始ロジック
  - [ ] 価格開示ロジック
  - [ ] 商品終了ロジック
  - [ ] 緊急停止ロジック
- [ ] Handler層: HTTPエンドポイント実装
  - [ ] POST /api/auctions/:id/start
  - [ ] POST /api/items/:id/open-price
  - [ ] POST /api/items/:id/end
  - [ ] POST /api/auctions/:id/cancel
  - [ ] GET /api/auctions/:id
  - [ ] GET /api/items/:id/bids
  - [ ] GET /api/auctions/:id/participants
  - [ ] GET /api/items/:id/price-history
- [ ] Middleware層: JWT認証、ロールチェック

### 16.2 フェーズ2: WebSocket実装（推定: 4日）

- [ ] WebSocket層: Hub, Client, EventHandler実装
- [ ] Redis Pub/Sub統合
- [ ] イベント定義
  - [ ] auction:started
  - [ ] auction:price_open
  - [ ] auction:bid
  - [ ] auction:ended
  - [ ] auction:cancelled
- [ ] 接続管理、自動再接続
- [ ] レート制限、エラーハンドリング

### 16.3 フェーズ3: フロントエンド基礎（推定: 6日）

- [ ] ページコンポーネント: AuctionLive.vue
- [ ] 子コンポーネント実装
  - [ ] ItemInfo.vue
  - [ ] ControlPanel.vue
  - [ ] BidHistory.vue
  - [ ] ParticipantList.vue
  - [ ] PriceHistoryList.vue
  - [ ] ImageSlider.vue
- [ ] Pinia Store: auctionStore.js
- [ ] API Service: auctionApi.js
- [ ] WebSocket Service: websocketService.js
- [ ] ルーティング設定（Vue Router）

### 16.4 フェーズ4: UI/UX実装（推定: 5日）

- [ ] デザイン適用（Shadcn Vue + Tailwind CSS）
- [ ] レスポンシブデザイン実装
  - [ ] スマートフォンレイアウト
  - [ ] タブレットレイアウト
  - [ ] デスクトップレイアウト
- [ ] アニメーション実装
  - [ ] 新規入札のフェードイン、ハイライト
  - [ ] 価格更新のパルスアニメーション
  - [ ] 参加者ステータス変化
- [ ] モーダル実装
  - [ ] 確認モーダル（価格開示、商品終了、緊急停止）
  - [ ] 落札者発表モーダル
- [ ] 通知システム（成功/エラー）

### 16.5 フェーズ5: テスト・デバッグ（推定: 4日）

- [ ] 機能テスト（全シナリオ）
- [ ] エッジケーステスト
- [ ] レスポンシブデザインテスト（実機確認）
- [ ] アクセシビリティテスト
- [ ] パフォーマンステスト（WebSocket負荷、多数の入札）
- [ ] バグ修正

### 16.6 フェーズ6: ドキュメント・デプロイ（推定: 2日）

- [ ] APIドキュメント作成
- [ ] ユーザーマニュアル作成（主催者向け）
- [ ] デプロイ手順確認
- [ ] 本番環境設定（環境変数、CORS設定）

**合計推定時間**: 26日（約5週間）

---

## 17. 成功基準

実装完了時に以下の基準をすべて満たすこと:

- [ ] 主催者がオークションを開始できる
- [ ] 主催者が価格を開示でき、全ての入札者画面にリアルタイムで反映される
- [ ] 入札者の入札が主催者画面にリアルタイムで表示される
- [ ] 主催者が商品を終了でき、落札者が正確に確定される
- [ ] system_adminがオークションを緊急停止でき、ポイントが返金される
- [ ] WebSocket切断時に自動再接続が機能する
- [ ] レスポンシブデザインがすべてのデバイスで正常に動作する
- [ ] バリデーションエラーが適切に表示される
- [ ] ロール別のアクセス制御が機能する
- [ ] パフォーマンスが許容範囲内（100名同時接続で遅延1秒以内）

---

## 18. 次のステップ

本画面実装後、以下の機能を順次実装予定:

1. **入札者用オークション画面（2.3.2）**: 入札者側のリアルタイム表示と入札機能
2. **オークション一覧画面（1.3.1）**: 管理者用の一覧・検索機能
3. **オークション編集画面（1.3.3）**: 商品情報の編集、メディア管理
4. **ダッシュボード（1.1.2）**: 統計情報の表示、アクティビティ表示
5. **カテゴリ別詳細情報**: 競走馬、美術品、車両ごとのメタデータ管理

---

**最終更新**: 2025年11月26日
**バージョン**: 1.0.0
**ステータス**: レビュー待ち
