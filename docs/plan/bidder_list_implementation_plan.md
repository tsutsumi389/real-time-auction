# 入札者一覧画面（1.2.4）実装プラン

**作成日**: 2025年11月22日
**対象画面**: 入札者一覧画面（Bidder List）
**パス**: `/admin/bidders`
**権限**: system_admin
**優先度**: 高（フェーズ2: 管理機能拡充）

---

## 1. 概要

### 1.1 目的
システム管理者が、システム内のすべての入札者アカウントを一覧表示し、ポイント管理を行うための画面です。入札者の検索、フィルタリング、ポイント付与、状態変更が可能です。

### 1.2 対象ユーザー
- **system_admin（システム管理者）**: この画面にアクセスできる唯一のロール
- auctioneersは入札者管理画面にアクセスできません

### 1.3 主要機能
1. 入札者アカウントの一覧表示（ID、メールアドレス、表示名、ポイント情報、状態、作成日）
2. 検索機能（メールアドレス、表示名）
3. フィルタリング機能（状態別、ポイント残高順）
4. ソート機能（作成日順、メールアドレス順、ポイント残高順）
5. ページネーション（20件/ページ）
6. ポイント付与機能（モーダル形式）
7. ポイント履歴表示（モーダル形式）
8. アカウント状態の変更（有効化・停止）
9. 入札者編集画面への遷移
10. 新規入札者登録画面への遷移

---

## 2. 画面レイアウト

### 2.1 画面構成

```
┌───────┬─────────────────────────────────────────────────────────────┐
│       │ [ロゴ] 入札者一覧                           [ログアウト]    │
│       ├─────────────────────────────────────────────────────────────┤
│ サイド│                                                             │
│ メニュー │ 入札者一覧                                                   │
│       │                                                             │
│ ☰ メニュー│ ┌─────────────────────────────────────────────────────────┐ │
│       │ │ [+ 新規入札者登録]                 [検索: __________] 🔍 │ │
│ [ダッシュ]│ │                                                         │ │
│ ボード│ │ フィルタ:                                                │ │
│       │ │ 状態:   [すべて▾] [有効] [停止] [削除済み]                │ │
│ [オーク]│ │ ポイント: [すべて▾] [高い順] [低い順]                    │ │
│ ション│ └─────────────────────────────────────────────────────────┘ │
│       │                                                             │
│ [入札者]│ ┌─────────────────────────────────────────────────────────┐ │
│       │ │ID ▲│メール       │表示名 │ポイント │状態│作成日  │アクション      │ │
│ [管理者]│ ├─────────────────────────────────────────────────────────┤ │
│       │ │abc..│user1@ex.com │田中太郎│ 10,000 │有効│2025/01/01│[詳細][pt付与][履歴]│ │
│       │ │def..│user2@ex.com │佐藤花子│  5,000 │有効│2025/01/02│[詳細][pt付与][履歴]│ │
│       │ │ghi..│user3@ex.com │鈴木一郎│ 15,000 │停止│2025/01/03│[詳細][pt付与][履歴]│ │
│       │ │ ... │ ...         │ ...   │  ...   │...│...      │ ...              │ │
│       │ └─────────────────────────────────────────────────────────┘ │
│       │                                                             │
│       │ 1-20件 / 全150件    [◀ 前へ] [1] [2] [3] [次へ ▶]           │
│       │                                                             │
└───────┴─────────────────────────────────────────────────────────────┘
```

### 2.2 デザイン要件

- **レイアウト**: 全幅のテーブルレイアウト、最大幅1600px
- **カード**: 白い背景、薄い影
- **テーブル**: 明確な行区切り、ホバー時に背景色がハイライト
- **ボタン**:
  - 新規登録ボタン: 青系（primary）、目立つ配置
  - 詳細ボタン: 灰色系（secondary）
  - ポイント付与ボタン: 緑系（success）
  - 履歴ボタン: 紫系（info）
  - 停止ボタン: 赤系（destructive）
  - 復活ボタン: 緑系（success）
- **バッジ**:
  - 状態: `active`（緑バッジ）、`suspended`（黄バッジ）、`deleted`（灰バッジ）
- **ポイント表示**: 数値は3桁区切りカンマ（例: 10,000）
- **ID表示**: UUID先頭8文字のみ表示（例: abc12345）
- **検索フィールド**: 右上に配置、アイコン付き
- **フィルタ**: ドロップダウン形式、複数選択可能

---

## 3. 表示項目の仕様

### 3.1 テーブル列の定義

| 列名 | データ型 | 説明 | 表示形式 | ソート | 幅 |
|------|---------|------|---------|-------|-----|
| **ID** | UUID | 入札者ID | 先頭8文字のみ | ○ | 100px |
| **メールアドレス** | VARCHAR(255) | ログインに使用するメール | テキスト | ○ | 250px |
| **表示名** | VARCHAR(100) | 画面に表示される名前 | テキスト | × | 150px |
| **ポイント** | BIGINT | 現在のポイント残高（total_points） | 3桁区切りカンマ | ○ | 120px |
| **状態** | VARCHAR(20) | active / suspended / deleted | バッジ | × | 100px |
| **作成日** | TIMESTAMP | アカウント作成日時 | YYYY/MM/DD | ○ | 120px |
| **アクション** | - | 詳細・ポイント付与・履歴ボタン | ボタン | × | 220px |

### 3.2 バッジの表示仕様

**状態バッジ**:
- `active`: 緑背景、白文字、「有効」
- `suspended`: 黄背景、黒文字、「停止」
- `deleted`: 灰背景、白文字、「削除済み」

### 3.3 表示名の処理

- 表示名が設定されている場合: 表示名を表示
- 表示名が未設定（NULL）の場合: 「（未設定）」と表示

### 3.4 UUID表示

- UUIDの先頭8文字のみ表示（例: `abc12345`）
- ホバー時にツールチップで完全なUUIDを表示
- クリックでクリップボードにコピー

### 3.5 ポイント残高の表示

- ポイント = 現在のポイント残高（total_points）
- 3桁区切りカンマで表示（例: 10,000）
- ポイントの詳細（利用可能/予約中）は詳細画面またはポイント履歴モーダルで確認可能

---

## 4. 検索・フィルタリング機能

### 4.1 検索機能

**検索対象**:
- メールアドレス（部分一致）
- 表示名（部分一致）

**検索動作**:
- 検索ボックスに入力後、Enterキー押下またはボタンクリックで検索実行
- 検索結果がない場合: 「該当する入札者が見つかりませんでした」と表示
- 検索クリアボタン（×）で検索条件をリセット

**検索仕様**:
- 大文字・小文字を区別しない（ILIKE検索）
- 前方一致、中間一致、後方一致すべて対象
- メールアドレスまたは表示名のいずれかに一致すれば表示

### 4.2 状態別フィルタ

| フィルタ値 | 表示内容 |
|-----------|---------|
| すべて | すべての状態を表示（デフォルト） |
| active | 有効なアカウントのみ表示 |
| suspended | 停止中のアカウントのみ表示 |
| deleted | 削除済みアカウントのみ表示 |

**デフォルト表示**:
- 初期表示では `active` と `suspended` のみ表示（削除済みは非表示）

### 4.3 ポイント順フィルタ

| フィルタ値 | 表示内容 |
|-----------|---------|
| すべて | デフォルトソート（作成日昇順） |
| 高い順 | ポイント残高（total_points）の降順 |
| 低い順 | ポイント残高（total_points）の昇順 |

### 4.4 複合フィルタ

- 状態フィルタとポイント順フィルタは組み合わせ可能
- 検索キーワードとフィルタも組み合わせ可能
- 例: 「有効状態」かつ「ポイント高い順」かつ「メールに`tanaka`を含む」

---

## 5. ソート機能

### 5.1 ソート可能な列

| 列名 | ソート順 | デフォルト |
|------|---------|----------|
| ID | 昇順・降順 | - |
| メールアドレス | 昇順・降順 | - |
| ポイント | 昇順・降順 | - |
| 作成日 | 昇順・降順 | 昇順（デフォルト） |

### 5.2 ソート動作

- 列ヘッダーをクリックでソート実行
- 初回クリック: 昇順
- 2回目クリック: 降順
- 3回目クリック: ソート解除（デフォルトに戻る）
- ソート中の列にはアイコン表示（▲昇順、▼降順）

### 5.3 デフォルトソート

- 作成日昇順（登録日が古い順）

---

## 6. ページネーション

### 6.1 ページング仕様

- **表示件数**: 20件/ページ（固定）
- **ページ番号**: 最大5ページまで表示
- **総件数表示**: 「1-20件 / 全150件」の形式

### 6.2 ページネーションUI

```
[◀ 前へ] [1] [2] [3] [4] [5] [次へ ▶]
```

- 現在のページ番号はハイライト表示
- 最初のページでは「前へ」ボタンが無効
- 最後のページでは「次へ」ボタンが無効
- ページ番号をクリックで直接ジャンプ

---

## 7. アクション機能

### 7.1 詳細ボタン

**動作**:
- クリックで入札者編集画面（1.2.6）へ遷移
- パス: `/admin/bidders/:id/edit`

**表示条件**:
- すべてのアカウントで表示

### 7.2 ポイント付与ボタン

**動作**:
- クリックでポイント付与モーダルを表示
- モーダル内容:
  - 入札者情報表示（ID、メールアドレス、表示名）
  - 現在のポイント残高表示
  - 付与ポイント入力フィールド（正の整数のみ）
  - 付与後のポイント残高プレビュー
  - [キャンセル] [付与する] ボタン

**処理フロー**:
1. 付与ポイント数を入力
2. バリデーション（1以上の整数）
3. 確認メッセージ: 「{付与ポイント数}ポイントを付与しますか?」
4. APIリクエスト送信（POST /api/admin/bidders/:id/points）
5. 成功時: モーダルを閉じ、成功メッセージ表示、一覧を再読み込み
6. 失敗時: エラーメッセージをモーダル内に表示

**表示条件**:
- `active` または `suspended` 状態のアカウントで表示
- `deleted` 状態では非表示

### 7.3 履歴ボタン

**動作**:
- クリックでポイント履歴モーダルを表示
- モーダル内容:
  - 入札者情報表示（ID、メールアドレス、表示名）
  - ポイント履歴テーブル
    - 列: 日時、種別、増減ポイント、残高、関連オークション、備考
    - 最新50件を表示
    - ページネーション（10件/ページ）

**ポイント履歴種別**:
- `grant`: 付与（緑色、+表示）
- `reserve`: 予約（黄色、-表示）
- `release`: 解放（青色、+表示）
- `consume`: 消費（赤色、-表示）
- `refund`: 返金（緑色、+表示）

**表示条件**:
- すべてのアカウントで表示

### 7.4 状態変更ボタン

**停止ボタン**:
- 対象: `active`状態のアカウント
- クリックで確認モーダル表示
  - タイトル: 「アカウントを停止しますか?」
  - メッセージ: 「このアカウントはログインできなくなります。」
  - ボタン: [キャンセル] [停止する]
- 実行後、状態が`suspended`に変更
- 成功メッセージ: 「アカウントを停止しました」

**復活ボタン**:
- 対象: `suspended`状態のアカウント
- クリックで確認モーダル表示
  - タイトル: 「アカウントを復活しますか?」
  - メッセージ: 「このアカウントは再びログインできるようになります。」
  - ボタン: [キャンセル] [復活する]
- 実行後、状態が`active`に変更
- 成功メッセージ: 「アカウントを復活しました」

**削除済みアカウント**:
- `deleted`状態のアカウントには状態変更ボタンを表示しない
- 削除済みアカウントは編集画面でのみ復旧可能

---

## 8. 処理フロー

### 8.1 初期表示フロー

```
[ユーザー操作]
  ↓
1. `/admin/bidders`にアクセス
  ↓
2. フロントエンドで認証チェック
   - JWTトークンの確認
   - ロールが`system_admin`であることを確認
  ↓
3. バックエンドAPIに一覧取得リクエスト送信
   - デフォルト: ページ1、20件、作成日昇順
   - デフォルトフィルタ: status IN ('active', 'suspended')
  ↓
4. バックエンドでデータ取得
   - biddersテーブルとbidder_pointsテーブルをJOIN
   - 該当レコードを取得
   - 総件数をカウント
   - ページネーション処理
  ↓
5. フロントエンドで一覧表示
   - テーブルにデータをレンダリング
   - ページネーションUI表示
```

### 8.2 検索・フィルタ実行フロー

```
[ユーザー操作]
  ↓
1. 検索キーワード入力またはフィルタ選択
  ↓
2. Enterキー押下またはボタンクリック
  ↓
3. フロントエンドでクエリパラメータ作成
  ↓
4. バックエンドAPIにリクエスト送信
   - パラメータ: keyword, status, point_sort, page, sort
  ↓
5. バックエンドでフィルタ処理
   - WHERE句に条件追加
   - LIKE検索、IN検索
   - ORDER BY句でソート
  ↓
6. フロントエンドで結果表示
   - ページ番号を1にリセット
   - 該当件数表示
```

### 8.3 ポイント付与フロー

```
[ユーザー操作]
  ↓
1. ポイント付与ボタンをクリック
  ↓
2. ポイント付与モーダル表示
   - 入札者情報と現在のポイント残高を表示
  ↓
3. 付与ポイント数を入力
  ↓
4. 「付与する」ボタンをクリック
  ↓
5. フロントエンドでバリデーション
   - 1以上の整数であることを確認
  ↓
6. バックエンドAPIにリクエスト送信
   - POST /api/admin/bidders/:id/points
   - Body: {"points": 1000}
  ↓
7. バックエンドでポイント付与処理（トランザクション）
   - bidder_pointsテーブルを更新
     - total_points += 付与ポイント
     - available_points += 付与ポイント
   - point_historyテーブルに記録を追加
     - type: 'grant'
     - points: 付与ポイント
     - balance_after: 更新後のtotal_points
  ↓
8. フロントエンドで成功処理
   - モーダルを閉じる
   - 成功メッセージを表示
   - 一覧を再読み込み
```

### 8.4 状態変更フロー

```
[ユーザー操作]
  ↓
1. 停止ボタンまたは復活ボタンをクリック
  ↓
2. 確認モーダル表示
  ↓
3. ユーザーが確認ボタンをクリック
  ↓
4. バックエンドAPIに状態変更リクエスト送信
   - PATCH /api/admin/bidders/:id/status
   - Body: {"status": "suspended"} または {"status": "active"}
  ↓
5. バックエンドでデータ更新
   - biddersテーブルのstatusカラムを更新
   - updated_atを現在時刻に更新
  ↓
6. フロントエンドで成功メッセージ表示
  ↓
7. 一覧を再読み込み（最新状態を反映）
```

---

## 9. セキュリティ要件

### 9.1 権限チェック

1. **フロントエンド**:
   - Vue Routerのナビゲーションガードで`system_admin`ロールを確認
   - ロールが異なる場合は403エラーページへリダイレクト

2. **バックエンド**:
   - すべてのエンドポイントでJWT認証ミドルウェアを適用
   - ロール検証ミドルウェアで`system_admin`を要求
   - 権限不足の場合は403エラーを返却

### 9.2 データ保護

1. **パスワードハッシュの非表示**:
   - APIレスポンスに`password_hash`を含めない
   - Repositoryレイヤーで除外

2. **削除済みアカウントの扱い**:
   - デフォルトでは非表示
   - 明示的にフィルタ選択時のみ表示

3. **UUID の扱い**:
   - 一覧では先頭8文字のみ表示
   - 完全なUUIDはAPIレスポンスに含める
   - フロントエンドで表示制御

### 9.3 ポイント付与のセキュリティ

1. **付与制限**:
   - 正の整数のみ許可（1以上）
   - 負の値や小数は拒否
   - 上限値を設定（例: 1回の付与は1,000,000ポイントまで）

2. **トランザクション処理**:
   - ポイント付与はデータベーストランザクションで実行
   - bidder_points更新とpoint_history挿入を同時にコミット
   - いずれかが失敗した場合はロールバック

3. **監査ログ**:
   - すべてのポイント付与をpoint_historyテーブルに記録
   - 付与者（system_admin）のIDも記録

### 9.4 CSRFとXSS対策

- JWTトークンを使用（Cookieベースではない）
- ユーザー入力は自動エスケープ（Vueの機能）
- APIからのレスポンスもエスケープ処理

---

## 10. データベース設計

### 10.1 使用テーブル

**biddersテーブル**（既存、マイグレーション001で作成済み）:

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| id | UUID | 入札者ID | 主キー |
| email | VARCHAR(255) | メールアドレス | 必須、ユニーク |
| password_hash | VARCHAR(255) | パスワードハッシュ | 必須 |
| display_name | VARCHAR(100) | 表示名 | 任意 |
| status | VARCHAR(20) | 状態 | 必須、CHECK制約 |
| created_at | TIMESTAMPTZ | 作成日時 | 自動設定 |
| updated_at | TIMESTAMPTZ | 更新日時 | 自動更新 |

**bidder_pointsテーブル**（既存、マイグレーション001で作成済み）:

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| bidder_id | UUID | 入札者ID | 主キー、外部キー |
| total_points | BIGINT | 累計ポイント | 必須、非負 |
| available_points | BIGINT | 利用可能ポイント | 必須、非負 |
| reserved_points | BIGINT | 予約中ポイント | 必須、非負 |
| updated_at | TIMESTAMPTZ | 更新日時 | 自動更新 |

**point_historyテーブル**（既存、マイグレーション002で作成済み）:

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| id | BIGSERIAL | 履歴ID | 主キー |
| bidder_id | UUID | 入札者ID | 外部キー |
| auction_id | BIGINT | オークションID | 外部キー（任意） |
| type | VARCHAR(20) | 種別 | 必須、CHECK制約 |
| points | BIGINT | ポイント増減 | 必須 |
| balance_before | BIGINT | 操作前残高 | 必須 |
| balance_after | BIGINT | 操作後残高 | 必須 |
| created_at | TIMESTAMPTZ | 作成日時 | 自動設定 |

### 10.2 インデックス（既存）

- `idx_bidders_email`: emailカラムにユニークインデックス（deleted以外）
- `idx_bidders_status`: statusカラムにBTreeインデックス（フィルタ高速化）
- `idx_bidder_points_available`: available_pointsカラムにBTreeインデックス（ソート高速化）
- `idx_point_history_bidder`: bidder_idカラムにBTreeインデックス（履歴取得高速化）

### 10.3 クエリ最適化

**一覧取得クエリ例**:
```sql
SELECT
  b.id, b.email, b.display_name, b.status, b.created_at,
  bp.total_points
FROM bidders b
LEFT JOIN bidder_points bp ON b.id = bp.bidder_id
WHERE b.status IN ('active', 'suspended')
  AND (b.email ILIKE '%keyword%' OR b.display_name ILIKE '%keyword%' OR 'keyword' IS NULL)
ORDER BY b.created_at ASC
LIMIT 20 OFFSET 0;
```

**総件数取得クエリ例**:
```sql
SELECT COUNT(*) FROM bidders
WHERE status IN ('active', 'suspended')
  AND (email ILIKE '%keyword%' OR display_name ILIKE '%keyword%' OR 'keyword' IS NULL);
```

**ポイント履歴取得クエリ例**:
```sql
SELECT
  ph.id, ph.type, ph.points, ph.balance_after, ph.created_at,
  a.title AS auction_title
FROM point_history ph
LEFT JOIN auctions a ON ph.auction_id = a.id
WHERE ph.bidder_id = 'uuid-here'
ORDER BY ph.created_at DESC
LIMIT 50 OFFSET 0;
```

---

## 11. API仕様

### 11.1 一覧取得API

**エンドポイント**: `GET /api/admin/bidders`

**クエリパラメータ**:

| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|---|------|------|-----|
| page | integer | × | ページ番号（デフォルト: 1） | 1 |
| limit | integer | × | 1ページあたりの件数（デフォルト: 20、最大: 100） | 20 |
| keyword | string | × | メールアドレス・表示名検索キーワード | tanaka |
| status | string | × | 状態フィルタ（active / suspended / deleted、カンマ区切りで複数指定可能） | active,suspended |
| sort | string | × | ソート順（id_asc / id_desc / email_asc / email_desc / points_asc / points_desc / created_at_asc / created_at_desc）（デフォルト: created_at_asc） | points_desc |

**リクエスト例**:
```
GET /api/admin/bidders?page=1&limit=20&keyword=tanaka&status=active,suspended&sort=created_at_asc
Authorization: Bearer {JWT_TOKEN}
```

**レスポンス形式（成功時）**:
```json
{
  "bidders": [
    {
      "id": "abc12345-def6-7890-abcd-ef1234567890",
      "email": "tanaka@example.com",
      "display_name": "田中太郎",
      "status": "active",
      "created_at": "2025-01-01T00:00:00Z",
      "points": 10000
    },
    {
      "id": "def67890-abc1-2345-6789-0abcdef12345",
      "email": "sato@example.com",
      "display_name": "佐藤花子",
      "status": "active",
      "created_at": "2025-01-02T00:00:00Z",
      "points": 5000
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "limit": 20,
    "total_pages": 8
  }
}
```

**レスポンス形式（失敗時）**:
```json
{
  "error": "Unauthorized"
}
```

### 11.2 ポイント付与API

**エンドポイント**: `POST /api/admin/bidders/:id/points`

**リクエスト形式**:
```
POST /api/admin/bidders/abc12345-def6-7890-abcd-ef1234567890/points
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "points": 1000
}
```

**レスポンス形式（成功時）**:
```json
{
  "bidder": {
    "id": "abc12345-def6-7890-abcd-ef1234567890",
    "email": "tanaka@example.com",
    "display_name": "田中太郎",
    "status": "active",
    "points": 11000
  },
  "history": {
    "id": 123,
    "type": "grant",
    "points": 1000,
    "balance_after": 11000,
    "created_at": "2025-01-10T12:00:00Z"
  }
}
```

**レスポンス形式（失敗時）**:
```json
{
  "error": "Invalid points value"
}
```

### 11.3 ポイント履歴取得API

**エンドポイント**: `GET /api/admin/bidders/:id/points/history`

**クエリパラメータ**:

| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|---|------|------|-----|
| page | integer | × | ページ番号（デフォルト: 1） | 1 |
| limit | integer | × | 1ページあたりの件数（デフォルト: 10、最大: 50） | 10 |

**リクエスト例**:
```
GET /api/admin/bidders/abc12345-def6-7890-abcd-ef1234567890/points/history?page=1&limit=10
Authorization: Bearer {JWT_TOKEN}
```

**レスポンス形式（成功時）**:
```json
{
  "bidder": {
    "id": "abc12345-def6-7890-abcd-ef1234567890",
    "email": "tanaka@example.com",
    "display_name": "田中太郎"
  },
  "history": [
    {
      "id": 123,
      "type": "grant",
      "points": 1000,
      "balance_before": 10000,
      "balance_after": 11000,
      "auction_id": null,
      "auction_title": null,
      "created_at": "2025-01-10T12:00:00Z"
    },
    {
      "id": 122,
      "type": "reserve",
      "points": -5000,
      "balance_before": 10000,
      "balance_after": 5000,
      "auction_id": 5,
      "auction_title": "競走馬オークション #5",
      "created_at": "2025-01-09T10:30:00Z"
    }
  ],
  "pagination": {
    "total": 50,
    "page": 1,
    "limit": 10,
    "total_pages": 5
  }
}
```

### 11.4 状態変更API

**エンドポイント**: `PATCH /api/admin/bidders/:id/status`

**リクエスト形式**:
```
PATCH /api/admin/bidders/abc12345-def6-7890-abcd-ef1234567890/status
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json

{
  "status": "suspended"
}
```

**レスポンス形式（成功時）**:
```json
{
  "id": "abc12345-def6-7890-abcd-ef1234567890",
  "email": "tanaka@example.com",
  "display_name": "田中太郎",
  "status": "suspended",
  "updated_at": "2025-01-10T12:00:00Z"
}
```

**レスポンス形式（失敗時）**:
```json
{
  "error": "Invalid status value"
}
```

### 11.5 エラーレスポンス一覧

| HTTPステータス | エラーメッセージ | 発生条件 |
|--------------|----------------|---------|
| 400 Bad Request | Invalid query parameters | クエリパラメータが不正 |
| 400 Bad Request | Invalid points value | ポイント値が不正（0以下、非整数など） |
| 400 Bad Request | Points exceed maximum limit | ポイント付与が上限を超過 |
| 401 Unauthorized | Unauthorized | JWT認証失敗 |
| 403 Forbidden | Insufficient permissions | ロールが`system_admin`でない |
| 404 Not Found | Bidder not found | 指定IDの入札者が存在しない |
| 500 Internal Server Error | Internal server error | サーバー内部エラー |

---

## 12. バックエンド実装要件

### 12.1 レイヤー構成

**Domain層（データモデル）**:
- Bidder構造体（新規作成）
- BidderPoints構造体（新規作成）
- PointHistory構造体（新規作成）
- BidderListRequest構造体（リクエストパラメータ）
- BidderListResponse構造体（レスポンス）
- GrantPointsRequest構造体（ポイント付与リクエスト）
- PointHistoryResponse構造体（ポイント履歴レスポンス）
- Pagination構造体（既存、再利用）

**Repository層（データアクセス）**:
- `FindBiddersWithFilters()`: フィルタ付き一覧取得（JOINでbidder_pointsも取得）
- `CountBiddersWithFilters()`: フィルタ付き総件数取得
- `GrantPoints()`: ポイント付与（トランザクション）
- `GetPointHistory()`: ポイント履歴取得
- `UpdateBidderStatus()`: 状態更新

**Service層（ビジネスロジック）**:
- `GetBidderList()`: 一覧取得処理
- `GrantPoints()`: ポイント付与処理
  - バリデーション（ポイント値チェック）
  - トランザクション管理
  - point_history記録
- `GetPointHistory()`: ポイント履歴取得処理
- `UpdateBidderStatus()`: 状態変更処理
  - バリデーション（ステータス値チェック）

**Handler層（APIエンドポイント）**:
- `GetBidderListHandler`: 一覧取得エンドポイント
- `GrantPointsHandler`: ポイント付与エンドポイント
- `GetPointHistoryHandler`: ポイント履歴取得エンドポイント
- `UpdateBidderStatusHandler`: 状態変更エンドポイント
- クエリパラメータのパース
- レスポンスの生成

### 12.2 ミドルウェア

- JWT認証ミドルウェア（既存）
- ロール検証ミドルウェア（`system_admin`のみ許可）

### 12.3 使用技術

- **フレームワーク**: Gin
- **ORM**: GORM
- **バリデーション**: go-playground/validator

---

## 13. フロントエンド実装要件

### 13.1 ディレクトリ構成

```
frontend/src/
  views/
    admin/
      BidderListView.vue             # 一覧画面コンポーネント
  components/
    bidder/
      BidderTable.vue                # テーブルコンポーネント
      BidderTableRow.vue             # テーブル行コンポーネント
      BidderFilters.vue              # フィルタコンポーネント
      BidderSearchBar.vue            # 検索バーコンポーネント
      BidderStatusBadge.vue          # 状態バッジコンポーネント
      GrantPointsDialog.vue          # ポイント付与モーダル
      PointHistoryDialog.vue         # ポイント履歴モーダル
      BidderStatusChangeDialog.vue   # 状態変更確認モーダル
    ui/
      table.vue                      # テーブルUIコンポーネント
      pagination.vue                 # ページネーションコンポーネント
      select.vue                     # セレクトボックス
      input.vue                      # 入力フィールド
      button.vue                     # ボタン
      badge.vue                      # バッジ
      dialog.vue                     # モーダルダイアログ
  services/
    api/
      bidderApi.ts                   # 入札者API呼び出し
  stores/
    bidderStore.ts                   # 入札者状態管理
  router/
    index.ts                         # ルーティング設定
```

### 13.2 実装コンポーネント

1. **一覧画面（BidderListView.vue）**:
   - ページ全体のレイアウト
   - 検索バー、フィルタ、テーブル、ページネーションの配置
   - データ取得処理
   - URLクエリパラメータの管理

2. **テーブルコンポーネント（BidderTable.vue）**:
   - 入札者一覧の表示
   - ソート機能
   - ヘッダー定義

3. **テーブル行コンポーネント（BidderTableRow.vue）**:
   - 各入札者の情報表示
   - アクションボタン（詳細、ポイント付与、履歴）
   - ポイント残高の表示
   - UUID短縮表示とツールチップ

4. **フィルタコンポーネント（BidderFilters.vue）**:
   - 状態フィルタ
   - ポイント順フィルタ
   - フィルタ変更時のイベント発火

5. **検索バーコンポーネント（BidderSearchBar.vue）**:
   - メールアドレス・表示名検索入力
   - 検索実行
   - 検索クリア

6. **ポイント付与モーダル（GrantPointsDialog.vue）**:
   - 入札者情報表示
   - 現在のポイント残高表示
   - 付与ポイント入力フィールド
   - 付与後のポイント残高プレビュー
   - 実行・キャンセルボタン
   - API呼び出し

7. **ポイント履歴モーダル（PointHistoryDialog.vue）**:
   - 入札者情報表示
   - ポイント履歴テーブル
   - 種別バッジ表示
   - ページネーション
   - API呼び出し

8. **状態変更確認モーダル（BidderStatusChangeDialog.vue）**:
   - 停止/復活の確認メッセージ
   - 実行・キャンセルボタン
   - API呼び出し

9. **入札者API Client（bidderApi.ts）**:
   - `getBidderList()`: 一覧取得
   - `grantPoints()`: ポイント付与
   - `getPointHistory()`: ポイント履歴取得
   - `updateBidderStatus()`: 状態変更
   - エラーハンドリング

10. **入札者状態管理（bidderStore.ts）**:
    - 一覧データの保持
    - フィルタ・検索条件の保持
    - ページネーション状態の保持
    - 一覧取得処理
    - ポイント付与処理
    - ポイント履歴取得処理
    - 状態変更処理
    - エラーメッセージの管理

11. **ルーティング設定（router/index.ts）**:
    - `/admin/bidders`へのルート定義
    - 認証ガード（`system_admin`のみ）

### 13.3 使用技術

- **フレームワーク**: Vue 3（Composition API）
- **UIライブラリ**: Shadcn Vue + Tailwind CSS
- **状態管理**: Pinia
- **HTTP Client**: Axios
- **ルーティング**: Vue Router

---

## 14. 画面遷移

### 14.1 遷移パターン

```
/admin/dashboard（ダッシュボード）
  ↓
  [入札者一覧]クリック
  ↓
/admin/bidders（入札者一覧）
  ↓
  ├─ [新規入札者登録]クリック
  │    ↓
  │  /admin/bidders/new（入札者登録）
  │
  ├─ [詳細]ボタンクリック
  │    ↓
  │  /admin/bidders/:id/edit（入札者編集）
  │
  ├─ [ポイント付与]ボタンクリック
  │    ↓
  │  ポイント付与モーダル表示（同一画面）
  │
  └─ [履歴]ボタンクリック
       ↓
     ポイント履歴モーダル表示（同一画面）
```

### 14.2 認証ガードの動作

1. **未認証ユーザーがアクセスした場合**:
   - `/admin/login`へ自動リダイレクト

2. **auctioneeerロールがアクセスした場合**:
   - 403エラーページを表示
   - メッセージ: 「この画面へのアクセス権限がありません」

3. **system_adminロールの場合**:
   - 正常に一覧画面を表示

---

## 15. UIの動作仕様

### 15.1 通常時の動作

1. **初期表示**:
   - デフォルトフィルタ: 有効・停止中のアカウント
   - ソート: 作成日昇順
   - ページ: 1ページ目

2. **ホバー時**:
   - テーブル行の背景色が薄いグレーに変化
   - 各ボタンの色が濃くなる
   - UUID列でツールチップが表示される

3. **検索実行時**:
   - ページ番号を1にリセット
   - 検索キーワードをハイライト表示（オプション）

4. **フィルタ変更時**:
   - ページ番号を1にリセット
   - 該当件数を再計算

5. **ページ遷移時**:
   - スムーズにスクロール（ページトップへ）
   - ローディング表示（スピナー）

### 15.2 ポイント付与時の動作

1. **ポイント付与ボタンクリック時**:
   - ポイント付与モーダルが表示される
   - 現在のポイント残高が表示される
   - モーダルの外側をクリック、またはEscキーでキャンセル

2. **ポイント入力時**:
   - リアルタイムで付与後のポイント残高をプレビュー
   - 不正な値（0以下、非整数）の場合はエラー表示

3. **API通信中**:
   - ボタンが無効化される
   - ボタンにスピナーアイコン表示

4. **成功時**:
   - モーダルを閉じる
   - 成功メッセージをトースト通知で表示（3秒間）
   - 一覧を自動再読み込み

5. **失敗時**:
   - エラーメッセージをモーダル内に表示
   - ボタンを再度有効化

### 15.3 ポイント履歴表示時の動作

1. **履歴ボタンクリック時**:
   - ポイント履歴モーダルが表示される
   - 最新10件の履歴が表示される

2. **種別バッジ**:
   - `grant`: 緑色、「付与」
   - `reserve`: 黄色、「予約」
   - `release`: 青色、「解放」
   - `consume`: 赤色、「消費」
   - `refund`: 緑色、「返金」

3. **ページング**:
   - 10件/ページで表示
   - 前へ・次へボタンで切り替え

---

## 16. レスポンシブデザイン

### 16.1 スマートフォン（767px以下）

- テーブルをカード形式に変更
- 各入札者情報をカードで表示
- フィルタはドロワー（引き出し）形式で表示
- ページネーションは簡略版（前へ・次へのみ）

**カードレイアウト例**:
```
┌─────────────────────────────────┐
│ abc12345                        │
│ tanaka@example.com              │
│ 田中太郎                         │
│ ポイント: 10,000pt               │
│ 状態: [有効]                     │
│ 作成日: 2025/01/01               │
│ [詳細] [pt付与] [履歴]            │
└─────────────────────────────────┘
```

### 16.2 タブレット（768px - 1279px）

- テーブル形式を維持
- 列幅を調整（一部列を非表示にするオプション）
- フィルタは折りたたみ可能

### 16.3 PC（1280px以上）

- フルテーブル表示
- すべての列を表示
- フィルタは常に表示

---

## 17. アクセシビリティ

### 17.1 キーボード操作

- Tabキー: ボタン・フィールド間の移動
- Enterキー: ボタンのクリック、検索実行
- Escapeキー: モーダルを閉じる
- 矢印キー: テーブル行間の移動（オプション）

### 17.2 スクリーンリーダー対応

- テーブルに`<caption>`を設定
- ヘッダーに`scope`属性を設定
- アクションボタンに`aria-label`を設定
  - 例: `aria-label="田中太郎のポイントを付与"`
- モーダルに`role="dialog"`、`aria-modal="true"`を設定
- UUID短縮表示に`aria-label`で完全なUUIDを設定

### 17.3 フォーカス表示

- キーボードフォーカスを明確に表示（青い枠線）
- スキップリンク（ナビゲーションをスキップしてメインコンテンツへ）

---

## 18. テスト要件

### 18.1 バックエンドテスト

**正常系テスト**:
- デフォルトパラメータで一覧取得成功
- フィルタ適用で正しい結果が返却される
- ページネーションが正しく機能する
- ソートが正しく機能する
- ポイント付与が正しく実行される
- ポイント履歴が正しく取得される
- 状態変更が正しく実行される

**異常系テスト**:
- 認証なしでアクセス（401エラー）
- auctioneeerロールでアクセス（403エラー）
- 存在しない入札者IDでポイント付与（404エラー）
- 不正なポイント値でポイント付与（400エラー）
- 不正なステータス値で状態変更（400エラー）
- 不正なクエリパラメータ（400エラー）

### 18.2 フロントエンドテスト

**コンポーネントテスト**:
- BidderListViewが正しくレンダリングされる
- フィルタ変更時に正しいAPIリクエストが送信される
- 検索実行時にURLクエリパラメータが更新される
- ポイント付与モーダルが正しく表示される
- ポイント履歴モーダルが正しく表示される
- 状態変更モーダルが正しく表示される

**統合テスト**:
- 一覧取得成功時にデータが表示される
- ポイント付与成功時に一覧が更新される
- ポイント履歴取得成功時に履歴が表示される
- 状態変更成功時に一覧が更新される
- エラー時にエラーメッセージが表示される

---

## 19. 環境変数

バックエンド・フロントエンドともに既存の環境変数を使用（`admin_login_implementation_plan.md`参照）。

---

## 20. 実装手順

### Phase 1: バックエンドAPI（5-6時間）
- [x] Domain層にBidder、BidderPoints、PointHistory構造体を定義
- [x] Domain層にBidderListRequest、BidderListResponse、GrantPointsRequest、PointHistoryResponse構造体を定義
- [x] Repository層にフィルタ付き一覧取得、総件数取得、ポイント付与、ポイント履歴取得、状態更新メソッドを実装
- [x] Service層に一覧取得、ポイント付与、ポイント履歴取得、状態変更ロジックを実装
- [x] Handler層に一覧取得、ポイント付与、ポイント履歴取得、状態変更エンドポイントを実装
- [x] ルーティング設定とミドルウェア適用
- [x] 手動テスト（curlまたはPostman）

### Phase 2: フロントエンド基盤（3-4時間）
- [x] bidderApi.tsにgetBidderList、grantPoints、getPointHistory、updateBidderStatusを実装
- [x] bidderStore.tsに状態管理を実装
- [x] ルーティング設定（/admin/bidders）と認証ガード

### Phase 3: フロントエンドUI（6-8時間）
- [ ] BidderListView.vueの実装
- [ ] BidderTable.vueの実装
- [ ] BidderFilters.vueの実装
- [ ] BidderSearchBar.vueの実装
- [ ] BidderStatusBadge.vueの実装
- [ ] GrantPointsDialog.vueの実装
- [ ] PointHistoryDialog.vueの実装
- [ ] BidderStatusChangeDialog.vueの実装
- [ ] ページネーションUIの実装

### Phase 4: テストと検証（3-4時間）
- [ ] バックエンドユニットテストの作成
- [ ] フロントエンドコンポーネントテストの作成
- [ ] 統合テストの実施
- [ ] レスポンシブデザインの検証
- [ ] アクセシビリティの検証

**合計想定時間**: 17-22時間

---

## 21. 成功基準

以下の条件がすべて満たされたら実装完了とします:

- [ ] 入札者一覧が正しく表示される
- [ ] 検索機能が正しく動作する
- [ ] 状態・ポイント順フィルタが正しく動作する
- [ ] ソート機能が正しく動作する
- [ ] ページネーションが正しく動作する
- [ ] ポイント付与が正しく動作する
- [ ] ポイント履歴表示が正しく動作する
- [ ] アカウント停止・復活が正しく動作する
- [ ] 詳細ボタンから編集画面へ遷移できる
- [ ] system_adminロールのみアクセス可能
- [ ] レスポンシブデザインが正しく動作する
- [ ] すべてのテストが通過する

---

## 22. 次のステップ

この実装完了後、以下の機能を実装予定:

1. **入札者登録画面（1.2.5）**:
   - 新規入札者アカウントの作成
   - 初期ポイント付与

2. **入札者編集画面（1.2.6）**:
   - 既存入札者アカウントの編集
   - パスワード変更
   - ポイント付与
   - 入札履歴表示

3. **ダッシュボード（1.1.2）**:
   - システム統計表示
   - 最近のアクティビティ

---

## 23. 参考資料

### 23.1 関連ドキュメント

- [画面一覧](../screen_list.md): すべての画面の概要
- [データベース定義](../database_definition.md): テーブル構造の詳細
- [管理者一覧実装プラン](admin_list_implementation_plan.md): 類似画面の参考
- [管理者ログイン実装プラン](admin_login_implementation_plan.md): 認証処理の参考

---

**作成者**: Claude Code
**レビュー状態**: 未レビュー
**最終更新**: 2025年11月22日
